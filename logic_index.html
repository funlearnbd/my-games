<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Kids Logic Adventure</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
<style>
Â  :root {
Â  Â  --accent-1: #FF6B6B;
Â  Â  --accent-2: #FFD700;
Â  Â  --accent-3: #1E90FF;
Â  Â  --good: #22c55e;
Â  Â  --bad: #ef4444;
Â  Â  --bg-gradient-start: #F9E79F;
Â  Â  --bg-gradient-end: #85C1E9;
Â  }
Â  html, body {
Â  Â  height: 100%;
Â  Â  margin: 0;
Â  Â  font-family: 'Inter', system-ui, sans-serif;
Â  Â  color: #333;
Â  }
Â  body {
Â  Â  background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  justify-content: center;
Â  Â  padding: 12px;
Â  Â  animation: background-flow 20s ease infinite;
Â  Â  background-size: 200% 200%;
Â  }
Â  @keyframes background-flow {
Â  Â  0% { background-position: 0% 50%; }
Â  Â  50% { background-position: 100% 50%; }
Â  Â  100% { background-position: 0% 50%; }
Â  }
Â  .container {
Â  Â  width: 100%;
Â  Â  max-width: 820px;
Â  Â  background: rgba(255, 255, 255, 0.95);
Â  Â  border-radius: 24px;
Â  Â  box-shadow: 0 20px 50px rgba(5, 10, 20, 0.12);
Â  Â  padding: 24px;
Â  Â  box-sizing: border-box;
Â  Â  min-height: 86vh;
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  gap: 16px;
Â  }
Â  /* --- Splash Screen Styles --- */
Â  .splash-screen {
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  justify-content: center;
Â  Â  align-items: center;
Â  Â  text-align: center;
Â  Â  gap: 30px;
Â  Â  padding: 40px;
Â  Â  flex: 1;
Â  }
Â  .splash-screen h1 {
Â  Â  font-size: clamp(2.5rem, 10vw, 5rem);
Â  Â  font-weight: 900;
Â  Â  color: var(--accent-3);
Â  Â  margin: 0;
Â  Â  text-shadow: 4px 4px 6px rgba(0,0,0,0.1);
Â  Â  animation: title-pop 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55);
Â  }
Â  .splash-screen p {
Â  Â  font-size: 1.25rem;
Â  Â  color: #555;
Â  Â  font-weight: 500;
Â  Â  margin: 0;
Â  }
Â  #start-game-btn {
Â  Â  padding: 20px 40px;
Â  Â  font-size: 1.5rem;
Â  Â  font-weight: bold;
Â  Â  border-radius: 50px;
Â  Â  background: linear-gradient(135deg, #FFD700, #FFA500);
Â  Â  color: #fff;
Â  Â  border: none;
Â  Â  cursor: pointer;
Â  Â  box-shadow: 0 8px 20px rgba(255, 165, 0, 0.4);
Â  Â  transition: transform 0.2s, box-shadow 0.2s, background 0.4s;
Â  Â  animation: pulse 2s infinite;
Â  }
Â  @keyframes pulse {
Â  Â  0%, 100% { transform: scale(1); box-shadow: 0 0 12px 6px rgba(255, 165, 0, 0.4); }
Â  Â  50% { transform: scale(1.05); box-shadow: 0 0 20px 10px rgba(255, 165, 0, 0.6); }
Â  }
Â  #start-game-btn:hover {
Â  Â  transform: scale(1.05);
Â  Â  box-shadow: 0 10px 25px rgba(255, 165, 0, 0.5);
Â  }
Â  #start-game-btn:active {
Â  Â  transform: scale(0.98);
Â  }
Â  .spinner {
Â  Â  border: 4px solid rgba(0, 0, 0, 0.1);
Â  Â  width: 30px;
Â  Â  height: 30px;
Â  Â  border-radius: 50%;
Â  Â  border-left-color: var(--accent-1);
Â  Â  animation: spin 1s linear infinite;
Â  Â  margin-top: 10px;
Â  Â  display: none;
Â  }
Â  @keyframes spin {
Â  Â  0% { transform: rotate(0deg); }
Â  Â  100% { transform: rotate(360deg); }
Â  }
Â  /* --- Game Board Styles --- */
Â  .app {
Â  Â  width: 100%;
Â  Â  max-width: 820px;
Â  Â  background: rgba(255, 255, 255, 0.95);
Â  Â  border-radius: 24px;
Â  Â  box-shadow: 0 20px 50px rgba(5, 10, 20, 0.12);
Â  Â  padding: 24px;
Â  Â  box-sizing: border-box;
Â  Â  min-height: 86vh;
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  gap: 16px;
Â  }
Â  .top {
Â  Â  display: flex;
Â  Â  justify-content: space-between;
Â  Â  align-items: center;
Â  Â  padding-bottom: 8px;
Â  Â  border-bottom: 2px solid #f0f0f0;
Â  }
Â  .title {
Â  Â  font-weight: 800;
Â  Â  color: var(--accent-3);
Â  Â  font-size: 1.8rem;
Â  Â  margin: 0;
Â  }
Â  .controls {
Â  Â  display: flex;
Â  Â  gap: 8px;
Â  Â  align-items: center;
Â  }
Â  button {
Â  Â  cursor: pointer;
Â  Â  border: none;
Â  Â  padding: 10px 18px;
Â  Â  border-radius: 12px;
Â  Â  font-weight: 700;
Â  Â  transition: transform 0.1s, box-shadow 0.1s;
Â  Â  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
Â  }
Â  button:active {
Â  Â  transform: translateY(2px);
Â  Â  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
Â  }
Â  .btn-primary {
Â  Â  background: var(--accent-3);
Â  Â  color: white;
Â  }
Â  .btn-exit {
Â  Â  background: var(--bad);
Â  Â  color: white;
Â  }
Â  .btn-ghost {
Â  Â  background: transparent;
Â  Â  border: 2px solid #e0e0e0;
Â  Â  color: #555;
Â  }
Â  .meta {
Â  Â  color: #555;
Â  Â  font-weight: 700;
Â  }
Â  .instructions {
Â  Â  font-size: 1.15rem;
Â  Â  color: #333;
Â  Â  font-weight: 700;
Â  Â  margin: 6px 0;
Â  Â  text-align: center;
Â  Â  min-height: 28px; /* Prevent layout shift */
Â  }
Â  .board {
Â  Â  flex: 1;
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  gap: 20px;
Â  Â  align-items: center;
Â  Â  overflow: auto;
Â  Â  padding-bottom: 8px;
Â  }
Â  .grid {
Â  Â  width: 100%;
Â  Â  display: grid;
Â  Â  gap: 16px;
Â  Â  align-items: stretch;
Â  }
Â  .grid.cols-2 { grid-template-columns: repeat(2, 1fr); }
Â  .grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
Â  .grid.cols-4 { grid-template-columns: repeat(4, 1fr); }
Â  .slot {
Â  Â  background: #fefcf3;
Â  Â  border-radius: 18px;
Â  Â  aspect-ratio: 1/1;
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  justify-content: center;
Â  Â  font-size: clamp(36px, 9vw, 84px);
Â  Â  user-select: none;
Â  Â  position: relative;
Â  Â  border: 4px solid #f0f0f0;
Â  Â  transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.2s;
Â  }
Â  .slot:hover {
Â  Â  transform: scale(1.05);
Â  Â  box-shadow: 0 12px 30px rgba(10, 20, 60, 0.1);
Â  }
Â  .slot.blank {
Â  Â  background: linear-gradient(90deg, #e9e9f3, #dcdcf5);
Â  Â  color: #475569;
Â  Â  cursor: default;
Â  }
Â  .slot.correct { animation: correct-pop 0.9s ease both; }
Â  @keyframes correct-pop {
Â  Â  0% { transform: scale(1); box-shadow: 0 0 0 rgba(255,223,93,0); }
Â  Â  50% { transform: scale(1.2); box-shadow: 0 0 20px 12px rgba(255,223,93,0.85); }
Â  Â  100% { transform: scale(1); box-shadow: 0 0 0 rgba(255,223,93,0); }
Â  }
Â  .slot.wrong { animation: shake 0.45s ease both; }
Â  @keyframes shake {
Â  Â  0%, 100% { transform: translateX(0); }
Â  Â  25% { transform: translateX(-8px); }
Â  Â  75% { transform: translateX(8px); }
Â  }
Â  .glow {
Â  Â  box-shadow: 0 0 26px 8px rgba(99,102,241,0.35);
Â  Â  transform: scale(1.06) !important;
Â  }
Â  .options {
Â  Â  display: flex;
Â  Â  gap: 16px;
Â  Â  flex-wrap: wrap;
Â  Â  justify-content: center;
Â  }
Â  .option {
Â  Â  background: #fefdf5;
Â  Â  border-radius: 14px;
Â  Â  padding: 12px 18px;
Â  Â  font-size: clamp(28px, 6vw, 48px);
Â  Â  cursor: pointer;
Â  Â  min-width: 82px;
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  justify-content: center;
Â  Â  transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
Â  Â  border: 4px solid #f0f0f0;
Â  Â  box-shadow: 0 6px 12px rgba(0,0,0,0.08);
Â  }
Â  .option:hover {
Â  Â  transform: translateY(-6px);
Â  Â  box-shadow: 0 10px 30px rgba(10, 20, 60, 0.1);
Â  }
Â  .star {
Â  Â  position: absolute;
Â  Â  font-size: 18px;
Â  Â  pointer-events: none;
Â  Â  opacity: 0;
Â  Â  transform: translate(-50%,-50%) scale(0.6);
Â  }
Â  .star.animate {
Â  Â  animation: star-burst 900ms ease-out forwards;
Â  }
Â  @keyframes star-burst {
Â  Â  0% { opacity: 1; transform: translate(-50%,-50%) scale(0.6); }
Â  Â  100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(1.6); }
Â  }
Â  .footer {
Â  Â  display: flex;
Â  Â  justify-content: space-between;
Â  Â  align-items: center;
Â  Â  margin-top: 6px;
Â  Â  padding-top: 8px;
Â  Â  border-top: 2px solid #f0f0f0;
Â  }
Â  .score {
Â  Â  font-weight: 900;
Â  Â  color: #333;
Â  Â  font-size: 1.1rem;
Â  }
Â  @media (max-width: 480px) {
Â  Â  .grid.cols-4 { grid-template-columns: repeat(2, 1fr); }
Â  }
</style>
</head>
<body>
Â  <!-- Container for both splash and game -->
Â  <div class="container" id="mainContainer">
Â  Â  <!-- Splash Screen -->
Â  Â  <div class="splash-screen" id="splashScreen">
Â  Â  Â  <h1>Logic Puzzles! ðŸ§ âœ¨</h1>
Â  Â  Â  <p>Ready for an adventure? Tap the button to begin!</p>
Â  Â  Â  <button id="start-game-btn">Start Adventure</button>
Â  Â  Â  <div class="spinner" id="audio-loading-spinner"></div>
Â  Â  Â  <audio id="welcome-audio" preload="auto"></audio>
Â  Â  </div>
Â  Â  <!-- Game Board (hidden by default) -->
Â  Â  <div class="app" id="gameBoard" style="display: none;">
Â  Â  Â  <div class="top">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <div class="title">Logic Adventure ðŸŒŸ</div>
Â  Â  Â  Â  Â  <div class="meta"><span id="levelLabel">Level 1</span></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="controls">
Â  Â  Â  Â  Â  <button id="restartBtn" class="btn-ghost">Restart</button>
Â  Â  Â  Â  Â  <button id="exitBtn" class="btn-exit">Exit</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="board" id="board">
Â  Â  Â  Â  <div class="instructions" id="instructions">Press Start to play</div>
Â  Â  Â  Â  <div class="score">Score: <span id="score">0</span></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="footer">
Â  Â  Â  Â  <div style="font-size:0.95rem;color:#475569">Modes: Find â†’ Different â†’ Missing</div>
Â  Â  Â  Â  <div style="font-size:0.9rem;color:#334155">Tip: Listen and find the right emoji</div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
Â  <!-- gentle music, plays after Start (gesture) -->
Â  <audio id="bgAudio" loop preload="auto" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_2a9b9d347d.mp3?filename=kid-music-110271.mp3"></audio>
<script>
/* ====== Data & state ====== */
const ALL = [
Â  'ðŸ¶','ðŸ±','ðŸ˜','ðŸ¦’','ðŸ¦','ðŸ¼','ðŸ»','ðŸ°','ðŸ¨','ðŸ¯',
Â  'ðŸŽ','ðŸŒ','ðŸ‰','ðŸ‡','ðŸ“','ðŸ','ðŸ¥­','ðŸ’','ðŸ‘','ðŸŠ',
Â  'ðŸš—','ðŸšŒ','ðŸš‘','ðŸš’','ðŸšœ','ðŸš²','âœˆï¸','ðŸš€','ðŸš','ðŸš¤',
Â  'âš½','ðŸŽˆ','ðŸ§¸','ðŸŽ¸','ðŸŒ¸','ðŸŒž','ðŸŒˆ','ðŸ¬','ðŸ¦‹','ðŸ¢'
];
const POS = ['Hooray!','Great job!','Well done!','Excellent!','You are amazing!'];
const board = document.getElementById('board');
const instructionsEl = document.getElementById('instructions');
const levelLabel = document.getElementById('levelLabel');
const scoreEl = document.getElementById('score');
const restartBtn = document.getElementById('restartBtn');
const exitBtn = document.getElementById('exitBtn');
const bgAudio = document.getElementById('bgAudio');
const splashScreen = document.getElementById('splashScreen');
const gameBoard = document.getElementById('gameBoard');
const startGameBtn = document.getElementById('start-game-btn');
const audioLoadingSpinner = document.getElementById('audio-loading-spinner');
const welcomeAudio = document.getElementById('welcome-audio');
let level = 1;
let score = 0;
let isWaiting = false;
let tutorialShown = { findDifferent:false, findMissing:false, findTarget:false };
const LEVEL_SEQUENCE = [
Â  { mode:'findTarget', size:4 }, { mode:'findTarget', size:5 }, { mode:'findTarget', size:6 },
Â  { mode:'findDifferent', size:4 }, { mode:'findDifferent', size:5 }, { mode:'findDifferent', size:6 },
Â  { mode:'findMissing', size:4 }, { mode:'findMissing', size:5 }, { mode:'findMissing', size:6 },
Â  { mode:'findTarget', size:6 }, { mode:'findDifferent', size:6 }, { mode:'findMissing', size:6 },
Â  { mode:'findTarget', size:7 }, { mode:'findDifferent', size:7 }, { mode:'findMissing', size:7 }
];
let seqIndex = 0;
/* Utils */
function shuffle(arr){
Â  const a = arr.slice();
Â  for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
Â  return a;
}
function speak(text, opts={rate:0.85,pitch:1.2}) {
Â  try{
Â  Â  if('speechSynthesis' in window){
Â  Â  Â  window.speechSynthesis.cancel();
Â  Â  Â  const u = new SpeechSynthesisUtterance(text);
Â  Â  Â  u.lang='en-US'; u.rate = opts.rate; u.pitch = opts.pitch;
Â  Â  Â  window.speechSynthesis.speak(u);
Â  Â  }
Â  }catch(e){ console.warn('TTS fail',e) }
}
function colsClass(n){ if(n<=2) return 'cols-2'; if(n<=6) return 'cols-3'; return 'cols-4' }
function clearBoardBelowInstructions(){
Â  const prevGrid = board.querySelector('.grid');
Â  const prevOptions = board.querySelector('.options');
Â  if (prevGrid) prevGrid.remove();
Â  if (prevOptions) prevOptions.remove();
}
/* star burst */
function starBurst(el){
Â  for(let i=0;i<6;i++){
Â  Â  const s = document.createElement('div');
Â  Â  s.className='star'; s.textContent='âœ¨';
Â  Â  s.style.left='50%'; s.style.top='50%';
Â  Â  const tx=(Math.random()*160-80)+'px', ty=(Math.random()*140-70)+'px';
Â  Â  s.style.setProperty('--tx',tx); s.style.setProperty('--ty',ty);
Â  Â  el.appendChild(s);
Â  Â  requestAnimationFrame(()=> s.classList.add('animate'));
Â  Â  setTimeout(()=> s.remove(),950);
Â  }
}
/* Glow helper for tutorial (flash element for a few times) */
async function flashElements(els, times=2, interval=450){
Â  for(let t=0;t<times;t++){
Â  Â  els.forEach(e=> e.classList.add('glow'));
Â  Â  await new Promise(r=> setTimeout(r, interval));
Â  Â  els.forEach(e=> e.classList.remove('glow'));
Â  Â  await new Promise(r=> setTimeout(r, 140));
Â  }
}
/* ====== Mode renderers and logic ====== */
function renderGrid(emojis, clickable=true, correct=null){
Â  clearBoardBelowInstructions();
Â  const grid = document.createElement('div');
Â  grid.className = 'grid ' + colsClass(emojis.length);
Â  emojis.forEach((em, idx)=>{
Â  Â  const s = document.createElement('div');
Â  Â  s.className='slot';
Â  Â  s.textContent = em;
Â  Â  if(clickable && em!=='â“'){
Â  Â  Â  s.onclick = ()=> {
Â  Â  Â  Â  if(isWaiting) return;
Â  Â  Â  Â  if(correct !== null && em === correct){
Â  Â  Â  Â  Â  isWaiting = true;
Â  Â  Â  Â  Â  s.classList.add('correct'); starBurst(s);
Â  Â  Â  Â  Â  speak(POS[Math.floor(Math.random()*POS.length)], {rate:0.95,pitch:1.3});
Â  Â  Â  Â  Â  score += 10; scoreEl.textContent = score;
Â  Â  Â  Â  Â  setTimeout(()=> { isWaiting=false; nextLevel(); }, 1200);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  s.classList.add('wrong'); speak('Try again', {rate:0.95,pitch:1.05});
Â  Â  Â  Â  Â  setTimeout(()=> s.classList.remove('wrong'), 700);
Â  Â  Â  Â  }
Â  Â  Â  };
Â  Â  }
Â  Â  grid.appendChild(s);
Â  });
Â  board.appendChild(grid);
}
function renderOptions(opts, correct){
Â  const prev = board.querySelector('.options'); if(prev) prev.remove();
Â  const wrap = document.createElement('div'); wrap.className='options';
Â  opts.forEach(o=>{
Â  Â  const d = document.createElement('div'); d.className='option'; d.textContent=o;
Â  Â  d.onclick = ()=> {
Â  Â  Â  if(isWaiting) return;
Â  Â  Â  if(o === correct){
Â  Â  Â  Â  const blanks = board.querySelectorAll('.slot.blank');
Â  Â  Â  Â  if(blanks.length) {
Â  Â  Â  Â  Â  const blank = blanks[0];
Â  Â  Â  Â  Â  blank.textContent = o; blank.classList.add('correct'); starBurst(blank);
Â  Â  Â  Â  }
Â  Â  Â  Â  isWaiting = true;
Â  Â  Â  Â  speak(POS[Math.floor(Math.random()*POS.length)], {rate:0.95,pitch:1.3});
Â  Â  Â  Â  score += 10; scoreEl.textContent = score;
Â  Â  Â  Â  setTimeout(()=> { isWaiting=false; nextLevel(); }, 1200);
Â  Â  Â  } else {
Â  Â  Â  Â  d.animate([{transform:'translateY(0)'},{transform:'translateX(-8px)'},{transform:'translateX(8px)'},{transform:'translateY(0)'}],{duration:450});
Â  Â  Â  Â  speak('Try again', {rate:0.95,pitch:1.05});
Â  Â  Â  }
Â  Â  };
Â  Â  wrap.appendChild(d);
Â  });
Â  board.appendChild(wrap);
}
/* ----- Specific mode setups ----- */
async function setupFindTarget(size){
Â  const pool = shuffle(ALL).slice(0, size);
Â  const target = pool[Math.floor(Math.random()*pool.length)];
Â  instructionsEl.textContent = `Find the ${target}`;
Â  speak(`Find the ${target}`, {rate:0.82,pitch:1.25});
Â  renderGrid(pool, true, target);
Â  if(!tutorialShown.findTarget){
Â  Â  tutorialShown.findTarget = true;
Â  Â  await new Promise(r=>setTimeout(r,550));
Â  Â  const slots = Array.from(board.querySelectorAll('.slot'));
Â  Â  const targetSlots = slots.filter(s => s.textContent===target);
Â  Â  if(targetSlots.length){
Â  Â  Â  await flashElements(targetSlots.slice(0,1), 3, 430);
Â  Â  }
Â  }
}
async function setupFindDifferent(size){
Â  const pool = shuffle(ALL);
Â  const repeat = pool[0];
Â  const different = pool.find(e=> e!==repeat);
Â  const arr = new Array(size-1).fill(repeat).concat([different]);
Â  const placed = shuffle(arr);
Â  instructionsEl.textContent = 'Find the different item';
Â  speak('Find the different item', {rate:0.82,pitch:1.25});
Â  renderGrid(placed, true, different);
Â  if(!tutorialShown.findDifferent){
Â  Â  tutorialShown.findDifferent = true;
Â  Â  await new Promise(r=>setTimeout(r,600));
Â  Â  const slots = Array.from(board.querySelectorAll('.slot'));
Â  Â  const sameSlots = slots.filter(s => s.textContent === repeat);
Â  Â  const diffSlot = slots.find(s => s.textContent === different);
Â  Â  await flashElements(sameSlots.slice(0, Math.min(4, sameSlots.length)), 2, 380);
Â  Â  await new Promise(r=>setTimeout(r,200));
Â  Â  if(diffSlot) await flashElements([diffSlot], 4, 400);
Â  }
}
async function setupFindMissing(totalSlots){
Â  const pool = shuffle(ALL).slice(0, totalSlots);
Â  const missingIndex = Math.floor(Math.random()*totalSlots);
Â  const missingEmoji = pool[missingIndex];
Â  const display = pool.slice(); display[missingIndex] = 'â“';
Â  instructionsEl.textContent = 'Which emoji is missing?';
Â  speak('Which emoji is missing? Choose the right one to fill the blank!', {rate:0.82,pitch:1.28});
Â  renderGrid(display, false, null);
Â  const visible = pool.filter((_,i)=>i!==missingIndex);
Â  const twoVisible = shuffle(visible).slice(0,2);
Â  const options = shuffle([missingEmoji, ...twoVisible]);
Â  renderOptions(options, missingEmoji);
Â  if(!tutorialShown.findMissing){
Â  Â  tutorialShown.findMissing = true;
Â  Â  await new Promise(r=>setTimeout(r,600));
Â  Â  const blank = board.querySelector('.slot.blank');
Â  Â  if(blank) await flashElements([blank], 3, 420);
Â  Â  const optionEls = Array.from(board.querySelectorAll('.option'));
Â  Â  const correctOpt = optionEls.find(o => o.textContent === missingEmoji);
Â  Â  const visibleOptEls = optionEls.filter(o => twoVisible.includes(o.textContent));
Â  Â  await flashElements(visibleOptEls.slice(0,2), 2, 300);
Â  Â  await new Promise(r=>setTimeout(r,180));
Â  Â  if(correctOpt) await flashElements([correctOpt], 3, 420);
Â  }
}
/* ===== Next level controller (deterministic) ===== */
function nextLevel(){
Â  clearBoardBelowInstructions();
Â  const cur = LEVEL_SEQUENCE[seqIndex % LEVEL_SEQUENCE.length];
Â  levelLabel.textContent = `Level ${seqIndex + 1}`;
Â  if(cur.mode === 'findTarget') setupFindTarget(cur.size);
Â  else if(cur.mode === 'findDifferent') setupFindDifferent(cur.size);
Â  else if(cur.mode === 'findMissing') setupFindMissing(cur.size);
Â  seqIndex++;
}
/* --- TTS & Audio Helpers --- */
function base64ToArrayBuffer(base64) {
Â  const binaryString = window.atob(base64);
Â  const len = binaryString.length;
Â  const bytes = new Uint8Array(len);
Â  for (let i = 0; i < len; i++) {
Â  Â  bytes[i] = binaryString.charCodeAt(i);
Â  }
Â  return bytes.buffer;
}
function pcmToWav(pcmData, sampleRate) {
Â  const numChannels = 1;
Â  const sampleSize = 16;
Â  const numFrames = pcmData.length;
Â  const byteRate = sampleRate * numChannels * (sampleSize / 8);
Â  const blockAlign = numChannels * (sampleSize / 8);
Â  const subChunk2Size = numFrames * numChannels * (sampleSize / 8);
Â  const chunkSize = 36 + subChunk2Size;
Â  const buffer = new ArrayBuffer(chunkSize + 8);
Â  const view = new DataView(buffer);
Â  view.setUint32(0, 0x52494646, true);
Â  view.setUint32(4, chunkSize, true);
Â  view.setUint32(8, 0x57415645, true);
Â  view.setUint32(12, 0x666d7420, true);
Â  view.setUint32(16, 16, true);
Â  view.setUint16(20, 1, true);
Â  view.setUint16(22, numChannels, true);
Â  view.setUint32(24, sampleRate, true);
Â  view.setUint32(28, byteRate, true);
Â  view.setUint16(32, blockAlign, true);
Â  view.setUint16(34, sampleSize, true);
Â  view.setUint32(36, 0x64617461, true);
Â  view.setUint32(40, subChunk2Size, true);
Â  let offset = 44;
Â  for (let i = 0; i < numFrames; i++) {
Â  Â  view.setInt16(offset, pcmData[i], true);
Â  Â  offset += 2;
Â  }
Â  return new Blob([view], { type: 'audio/wav' });
}
async function fetchAndPlayWelcomeAudio() {
Â  audioLoadingSpinner.style.display = 'block';
Â  try {
Â  Â  const payload = {
Â  Â  Â  contents: [{
Â  Â  Â  Â  parts: [{ text: "Welcome to Logic Puzzle! Tap the shiny button to start the game." }]
Â  Â  Â  }],
Â  Â  Â  generationConfig: {
Â  Â  Â  Â  responseModalities: ["AUDIO"],
Â  Â  Â  Â  speechConfig: {
Â  Â  Â  Â  Â  voiceConfig: {
Â  Â  Â  Â  Â  Â  prebuiltVoiceConfig: { voiceName: "Puck" }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  model: "gemini-2.5-flash-preview-tts"
Â  Â  };
Â  Â  const apiKey = "";
Â  Â  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
Â  Â  const response = await fetch(apiUrl, {
Â  Â  Â  method: 'POST',
Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  body: JSON.stringify(payload)
Â  Â  });
Â  Â  const result = await response.json();
Â  Â  const part = result?.candidates?.[0]?.content?.parts?.[0];
Â  Â  const audioData = part?.inlineData?.data;
Â  Â  const mimeType = part?.inlineData?.mimeType;
Â  Â  if (audioData && mimeType && mimeType.startsWith("audio/")) {
Â  Â  Â  const sampleRateMatch = mimeType.match(/rate=(\d+)/);
Â  Â  Â  const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
Â  Â  Â  const pcmData = base64ToArrayBuffer(audioData);
Â  Â  Â  const pcm16 = new Int16Array(pcmData);
Â  Â  Â  const wavBlob = pcmToWav(pcm16, sampleRate);
Â  Â  Â  const audioUrl = URL.createObjectURL(wavBlob);
Â  Â  Â  welcomeAudio.src = audioUrl;
Â  Â  Â  welcomeAudio.play().catch(e => console.warn("Audio playback failed:", e));
Â  Â  } else {
Â  Â  Â  console.error("Failed to get valid audio data from API.");
Â  Â  Â  speak("Welcome to Logic Puzzle! Tap the shiny button to start the game.", { rate: 0.85, pitch: 1.2 });
Â  Â  }
Â  } catch (e) {
Â  Â  console.error("Error fetching audio:", e);
Â  Â  speak("Welcome to Logic Puzzle! Tap the shiny button to start the game.", { rate: 0.85, pitch: 1.2 });
Â  } finally {
Â  Â  audioLoadingSpinner.style.display = 'none';
Â  }
}
/* ===== Controls & initialization ===== */
startGameBtn.addEventListener('click', ()=>{
Â  splashScreen.style.display = 'none';
Â  gameBoard.style.display = 'flex';
Â  try{ bgAudio.currentTime = 0; bgAudio.play().catch(()=>{}); }catch(e){}
Â  level = 1; score = 0; seqIndex = 0; scoreEl.textContent = score;
Â  tutorialShown = { findDifferent:false, findMissing:false, findTarget:false };
Â  speak('Letâ€™s play! I will speak slowly and clearly â€” listen carefully!', {rate:0.8,pitch:1.35});
Â  setTimeout(()=> nextLevel(), 700);
});
restartBtn.addEventListener('click', ()=>{
Â  window.speechSynthesis.cancel();
Â  try{ bgAudio.pause(); bgAudio.currentTime = 0; }catch(e){}
Â  level = 1; score = 0; seqIndex = 0; scoreEl.textContent = score;
Â  tutorialShown = { findDifferent:false, findMissing:false, findTarget:false };
Â  instructionsEl.textContent = 'Restartingâ€¦';
Â  setTimeout(()=> { speak('Restarting!'); nextLevel(); }, 500);
});
exitBtn.addEventListener('click', ()=>{
Â  try{ bgAudio.pause(); }catch(e){}
Â  window.location.href = window.location.href; // Simple reload for exit
});
window.onload = () => {
Â  splashScreen.style.display = 'flex';
Â  gameBoard.style.display = 'none';
Â  instructionsEl.textContent = 'Tap Start to play!';
Â  levelLabel.textContent = 'Level 1';
Â  scoreEl.textContent = '0';
Â  fetchAndPlayWelcomeAudio();
};
</script>
</body>
</html>
