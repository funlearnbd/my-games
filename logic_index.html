<script>
const gameContainer = document.getElementById('game-container');
const startBtn = document.getElementById('start-btn');
const bgMusic = document.getElementById('bg-music');
const imageList = ['apple','ball','banana','car','cat','cherry','dog','fish','flower','kiwi','orange','pinapple','rabbit','rainbow','star','strawberry','syn','teddy','train'];
const feedback = ['Yay! ðŸŒŸ', 'Awesome!', 'Great Job!', 'Excellent!', 'You are amazing!'];
let level = 1;
let maxLevels = 10;
let currentTarget = '';

// Preload images and wait until all loaded
function preloadImages(callback) {
    let loaded = 0;
    imageList.forEach(name => {
        const img = new Image();
        img.src = `image/${name}.png?v=${Date.now()}`;
        img.onload = () => { 
            loaded++; 
            if(loaded===imageList.length) callback(); 
        };
        img.onerror = () => { console.warn(`Image not found: ${name}.png`); loaded++; if(loaded===imageList.length) callback(); };
    });
}

// Voice helper returns promise
function speak(text, rate=0.8){
    return new Promise((resolve)=>{
        const synth = window.speechSynthesis;
        const utter = new SpeechSynthesisUtterance(text);
        utter.rate = rate; utter.pitch=1.2;
        utter.onend = resolve;
        synth.speak(utter);
    });
}

function shuffle(arr){ return arr.sort(()=>Math.random()-0.5); }

function startGame() {
    level=1;
    bgMusic.volume=0.15;
    bgMusic.play().catch(err=>console.log(err));
    nextRound();
}

function createInstructions(text){
    const p=document.createElement('p'); p.className='instructions'; p.innerText=text; return p;
}

async function nextRound() {
    gameContainer.innerHTML = `
    <div class="top-bar">
      <h1>Fun Logic Adventure ðŸŒŸ</h1>
      <button onclick="exitGame()" class="exit-btn">Exit</button>
    </div>
    <p class="level-display">Level: ${level}</p>
    `;
    
    const roundType = level%3;
    let chosen = shuffle([...imageList]).slice(0,6);
    let instructionText='';

    if(roundType===0){ // Find target
        currentTarget = chosen[Math.floor(Math.random()*chosen.length)];
        instructionText = `Find the ${currentTarget}`;
        gameContainer.appendChild(createInstructions(instructionText));
        await speak(instructionText,0.8);
        
        const grid = document.createElement('div'); grid.className='emoji-grid';
        chosen.forEach(name=>{
            const div=document.createElement('div'); div.className='emoji-item';
            const img=document.createElement('img'); img.src=`image/${name}.png?v=${Date.now()}`;
            div.appendChild(img);
            div.onclick=()=>checkAnswer(div,name,currentTarget);
            grid.appendChild(div);
        });
        gameContainer.appendChild(grid);
        
    } else if(roundType===1){ // Find missing
        currentTarget = chosen[5];
        const question=[...chosen]; question[5]='blank';
        instructionText='Find the missing item';
        gameContainer.appendChild(createInstructions(instructionText));
        await speak(instructionText,0.8);

        const grid = document.createElement('div'); grid.className='emoji-grid';
        question.forEach(name=>{
            const div=document.createElement('div'); div.className='emoji-item';
            if(name==='blank'){ div.innerHTML='?'; div.style.background='#e0e0e0'; }
            else { const img=document.createElement('img'); img.src=`image/${name}.png?v=${Date.now()}`; div.appendChild(img);}
            grid.appendChild(div);
        });
        gameContainer.appendChild(grid);

        const options = [currentTarget,...shuffle([...imageList].filter(x=>x!==currentTarget)).slice(0,2)];
        shuffle(options);
        const optGrid=document.createElement('div'); optGrid.className='options-grid';
        options.forEach(name=>{
            const div=document.createElement('div'); div.className='emoji-item';
            const img=document.createElement('img'); img.src=`image/${name}.png?v=${Date.now()}`;
            div.appendChild(img);
            div.onclick=()=>selectMissing(div,name,grid);
            optGrid.appendChild(div);
        });
        gameContainer.appendChild(optGrid);
        
    } else { // Find different
        const sameItem = chosen[0];
        for(let i=0;i<chosen.length;i++) chosen[i]=sameItem;
        const diffIndex = Math.floor(Math.random()*chosen.length);
        currentTarget = shuffle([...imageList].filter(x=>x!==sameItem))[0];
        chosen[diffIndex]=currentTarget;
        instructionText='Find the different item';
        gameContainer.appendChild(createInstructions(instructionText));
        await speak(instructionText,0.8);

        const grid = document.createElement('div'); grid.className='emoji-grid';
        chosen.forEach(name=>{
            const div=document.createElement('div'); div.className='emoji-item';
            const img=document.createElement('img'); img.src=`image/${name}.png?v=${Date.now()}`;
            div.appendChild(img);
            div.onclick=()=>checkAnswer(div,name,currentTarget);
            grid.appendChild(div);
        });
        gameContainer.appendChild(grid);
    }
}

function checkAnswer(div,name,target){
    if(name===target){
        div.classList.add('correct');
        addStarEffect(div);
        speak(feedback[Math.floor(Math.random()*feedback.length)],0.9).then(()=>nextLevel());
    } else {
        div.style.border='2px solid red';
        speak('Oops! Try again',0.9);
        setTimeout(()=>{ div.style.border='2px solid #444'; },800);
    }
}

function selectMissing(div,name,grid){
    if(name===currentTarget){
        const blankDiv = Array.from(grid.children).find(d=>d.innerHTML==='?');
        blankDiv.innerHTML=`<img src="image/${name}.png?v=${Date.now()}" />`;
        checkAnswer(blankDiv,name,currentTarget);
    } else {
        div.style.border='2px solid red';
        speak('Oops! Try again',0.9);
        setTimeout(()=>{ div.style.border='2px solid #444'; },800);
    }
}

function nextLevel(){
    level++;
    if(level>maxLevels){
        gameContainer.innerHTML=`<h1>Game Over! ðŸŽ‰</h1><p class="instructions">You completed all levels!</p>
        <button class="start-btn" onclick="startGame()">Play Again</button>`;
        speak('Congratulations! You completed all levels!');
    } else nextRound();
}

function exitGame(){ bgMusic.pause(); window.location.href='index.html'; }

// Star effect
function addStarEffect(parent){
    const star = document.createElement('div');
    star.style.position='absolute'; star.style.width='40px'; star.style.height='40px';
    star.style.background='url(https://i.imgur.com/9j2b0gF.png) no-repeat center/contain';
    star.style.top='0'; star.style.left='0'; star.style.pointerEvents='none';
    parent.style.position='relative';
    parent.appendChild(star);
    setTimeout(()=>parent.removeChild(star),1000);
}

// Preload all images first
preloadImages(()=>{ startBtn.disabled=false; });
startBtn.onclick=startGame;
</script>
