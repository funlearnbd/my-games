<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Kids Logic â€” Fixed Missing & Different + Tutorial</title>
<style>
Â  :root{
Â  Â  --accent:#ff6b6b; --good:#22c55e; --bg1:#fff1f2; --bg2:#dbeafe;
Â  }
Â  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial}
Â  body{
Â  Â  background: linear-gradient(135deg,var(--bg1) 0%, #fef3c7 40%, var(--bg2) 100%);
Â  Â  display:flex;align-items:center;justify-content:center;padding:12px;
Â  Â  animation: background-animation 15s ease infinite;
Â  }

Â  @keyframes background-animation {
Â  Â  0% {background-position: 0% 50%;}
Â  Â  50% {background-position: 100% 50%;}
Â  Â  100% {background-position: 0% 50%;}
Â  }

Â  .app {
Â  Â  width:100%;max-width:820px;background:rgba(255,255,255,0.95);
Â  Â  border-radius:18px;box-shadow:0 20px 50px rgba(5,10,20,0.12);
Â  Â  padding:16px;box-sizing:border-box;min-height:86vh;display:flex;flex-direction:column;
Â  Â  gap:12px;
Â  }

Â  .top {display:flex;justify-content:space-between;align-items:center}
Â  .title{font-weight:800;color:var(--accent);font-size:1.4rem;margin:0}
Â  .controls{display:flex;gap:8px;align-items:center}
Â  button {cursor:pointer;border:0;padding:8px 12px;border-radius:10px;font-weight:700}
Â  .btn-primary{background:#06b6d4;color:white}
Â  .btn-exit{background:#ef4444;color:white}
Â  .btn-ghost{background:transparent;border:2px solid rgba(0,0,0,0.06)}
Â  .meta{color:#0f172a;font-weight:700}

Â  .instructions{font-size:1.05rem;color:#0f172a;font-weight:700;margin:6px 0}
Â  .board{flex:1;display:flex;flex-direction:column;gap:12px;align-items:center;overflow:auto;padding-bottom:8px}

Â  .grid{width:100%;display:grid;gap:12px;align-items:stretch}
Â  .grid.cols-2{grid-template-columns:repeat(2,1fr)}
Â  .grid.cols-3{grid-template-columns:repeat(3,1fr)}
Â  .grid.cols-4{grid-template-columns:repeat(4,1fr)}

Â  .slot{
Â  Â  background:#fff7ed;border-radius:14px;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;
Â  Â  font-size:clamp(36px,9vw,64px);user-select:none;position:relative;border:2px solid rgba(15,23,42,0.03);
Â  Â  transition:transform .14s ease,box-shadow .14s ease;
Â  }
Â  .slot:hover{transform:translateY(-6px);box-shadow:0 12px 30px rgba(10,20,60,0.06)}
Â  .slot.blank{background:linear-gradient(90deg,#f3f4f6,#e2e8f0);color:#475569;cursor:default}
Â  .slot.correct{animation:correct-glow .9s ease both}
Â  @keyframes correct-glow{
Â  Â  0%{transform:scale(1);box-shadow:0 0 0 rgba(255,223,93,0)}
Â  Â  50%{transform:scale(1.15);box-shadow:0 0 20px 12px rgba(255,223,93,0.85)}
Â  Â  100%{transform:scale(1);box-shadow:0 0 0 rgba(255,223,93,0)}
Â  }
Â  .slot.wrong{animation:shake .45s ease both}
Â  @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}

Â  /* glow tutorial highlight */
Â  .glow{box-shadow:0 0 26px 8px rgba(99,102,241,0.35);transform:scale(1.06) !important}

Â  .options{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
Â  .option{background:#fffaf0;border-radius:12px;padding:10px 14px;font-size:clamp(28px,6vw,48px);cursor:pointer;min-width:82px;display:flex;align-items:center;justify-content:center;transition:transform .12s}
Â  .option:hover{transform:translateY(-6px);box-shadow:0 10px 30px rgba(10,20,60,0.06)}

Â  .star{position:absolute;font-size:18px;pointer-events:none;opacity:0;transform:translate(-50%,-50%) scale(.6)}
Â  .star.animate{animation:star-burst 900ms ease-out forwards}
Â  @keyframes star-burst{0%{opacity:1;transform:translate(-50%,-50%) scale(.6)}100%{opacity:0;transform:translate(var(--tx),var(--ty)) scale(1.6)}}

Â  .footer{display:flex;justify-content:space-between;align-items:center;margin-top:6px}
Â  .score{font-weight:900;color:#0f172a}

Â  @media (max-width:480px){
Â  Â  .grid.cols-4{grid-template-columns:repeat(2,1fr)}
Â  }

Â  /* --- Splash Screen Styles --- */
Â  .splash-screen {
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  justify-content: center;
Â  Â  align-items: center;
Â  Â  text-align: center;
Â  Â  gap: 20px;
Â  Â  padding: 40px;
Â  Â  background: rgba(255, 255, 255, 0.95);
Â  Â  border-radius: 20px;
Â  Â  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
Â  Â  max-width: 600px;
Â  Â  width: 90%;
Â  }

Â  .splash-screen h1 {
Â  Â  font-size: clamp(2rem, 8vw, 4rem);
Â  Â  color: #ff6b6b;
Â  Â  margin: 0;
Â  Â  text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
Â  Â  animation: title-pop 0.8s ease-out;
Â  }

Â  @keyframes title-pop {
Â  Â  0% { transform: scale(0.5); opacity: 0; }
Â  Â  100% { transform: scale(1); opacity: 1; }
Â  }

Â  .splash-screen p {
Â  Â  font-size: 1.2rem;
Â  Â  color: #334155;
Â  Â  font-weight: 500;
Â  Â  margin: 0;
Â  }
Â  #start-game-btn {
Â  Â  padding: 20px 40px;
Â  Â  font-size: 1.5rem;
Â  Â  font-weight: bold;
Â  Â  border-radius: 50px;
Â  Â  background: linear-gradient(145deg, #38a169, #1e7d4d);
Â  Â  color: white;
Â  Â  border: none;
Â  Â  cursor: pointer;
Â  Â  box-shadow: 0 8px 20px rgba(46, 204, 113, 0.4);
Â  Â  transition: transform 0.2s, box-shadow 0.2s, background 0.4s;
Â  Â  animation: pulse 2s infinite;
Â  }
Â  @keyframes pulse {
Â  Â  0%, 100% { transform: scale(1); box-shadow: 0 0 12px 6px rgba(46, 204, 113, 0.4); }
Â  Â  50% { transform: scale(1.05); box-shadow: 0 0 20px 10px rgba(46, 204, 113, 0.6); }
Â  }
Â  #start-game-btn:hover {
Â  Â  transform: scale(1.05);
Â  Â  box-shadow: 0 10px 25px rgba(46, 204, 113, 0.5);
Â  }
Â  #start-game-btn:active {
Â  Â  transform: scale(0.98);
Â  }
Â  /* loading spinner for voice message */
Â  .spinner {
Â  Â  border: 4px solid rgba(0, 0, 0, 0.1);
Â  Â  width: 30px;
Â  Â  height: 30px;
Â  Â  border-radius: 50%;
Â  Â  border-left-color: #ff6b6b;
Â  Â  animation: spin 1s linear infinite;
Â  Â  margin-top: 10px;
Â  Â  display: none;
Â  }
Â  @keyframes spin {
Â  Â  0% { transform: rotate(0deg); }
Â  Â  100% { transform: rotate(360deg); }
Â  }
</style>
</head>
<body>
Â  <!-- Splash Screen -->
Â  <div class="splash-screen" id="splashScreen">
Â  Â  <h1>Fun Logic Adventure ðŸŒˆ</h1>
Â  Â  <p>Welcome! Tap the button to begin your puzzle adventure.</p>
Â  Â  <button id="start-game-btn">Start Game</button>
Â  Â  <div class="spinner" id="audio-loading-spinner"></div>
Â  Â  <audio id="welcome-audio" preload="auto"></audio>
Â  </div>

Â  <!-- Game Board (hidden by default) -->
Â  <div class="app" id="gameBoard" style="display: none;">
Â  Â  <div class="top">
Â  Â  Â  <div>
Â  Â  Â  Â  <div class="title">Fun Logic Adventure ðŸŒŸ</div>
Â  Â  Â  Â  <div class="meta"><span id="levelLabel">Level 1</span></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="controls">
Â  Â  Â  Â  <button id="restartBtn" class="btn-ghost">Restart</button>
Â  Â  Â  Â  <button id="exitBtn" class="btn-exit">Exit</button>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="board" id="board">
Â  Â  Â  <div class="instructions" id="instructions">Press Start to play</div>

Â  Â  Â  <div style="display:flex;gap:8px;width:100%;align-items:center;">
Â  Â  Â  Â  <button id="startBtn" class="btn-primary" style="background:#06b6d4;color:white;border-radius:10px;padding:10px 14px; display: none;">Start</button>
Â  Â  Â  Â  <div style="flex:1"></div>
Â  Â  Â  Â  <div class="score">Score: <span id="score">0</span></div>
Â  Â  Â  </div>
Â  Â  Â  <!-- dynamic grid and options appear here -->
Â  Â  </div>

Â  Â  <div class="footer">
Â  Â  Â  <div style="font-size:0.95rem;color:#475569">Mode rotates: Find â†’ Different â†’ Missing</div>
Â  Â  Â  <div style="font-size:0.9rem;color:#334155">Tip: Listen and tap the right emoji</div>
Â  Â  </div>
Â  </div>

Â  <!-- gentle music, plays after Start (gesture) -->
Â  <audio id="bgAudio" loop preload="auto" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_2a9b9d347d.mp3?filename=kid-music-110271.mp3"></audio>

<script>
/* ====== Data & state ====== */
const ALL = [
Â  'ðŸ•','ðŸˆ','ðŸ˜','ðŸ¦’','ðŸ¦','ðŸ¼','ðŸ»','ðŸ°','ðŸ¨','ðŸ¯',
Â  'ðŸŽ','ðŸŒ','ðŸ‰','ðŸ‡','ðŸ“','ðŸ','ðŸ¥­','ðŸ’','ðŸ‘','ðŸŠ',
Â  'ðŸš—','ðŸšŒ','ðŸš‘','ðŸš’','ðŸšœ','ðŸš²','âœˆï¸','ðŸš€','ðŸš','ðŸš¤',
Â  'âš½','ðŸŽˆ','ðŸ§¸','ðŸŽ¸','ðŸŒ¸','ðŸŒž','ðŸŒˆ','ðŸ¬','ðŸ¦‹','ðŸ¢'
];
const POS = ['Hooray!','Great job!','Well done!','Excellent!','You are amazing!'];
const board = document.getElementById('board');
const instructionsEl = document.getElementById('instructions');
const levelLabel = document.getElementById('levelLabel');
const scoreEl = document.getElementById('score');
const restartBtn = document.getElementById('restartBtn');
const exitBtn = document.getElementById('exitBtn');
const bgAudio = document.getElementById('bgAudio');

const splashScreen = document.getElementById('splashScreen');
const gameBoard = document.getElementById('gameBoard');
const startGameBtn = document.getElementById('start-game-btn');
const audioLoadingSpinner = document.getElementById('audio-loading-spinner');
const welcomeAudio = document.getElementById('welcome-audio');

let level = 1;
let score = 0;
let modeIndex = 0;
let isWaiting = false;
let tutorialShown = { findDifferent:false, findMissing:false, findTarget:false };

/* deterministic levels: easy -> medium -> hard for each mode, repeat */
const LEVEL_SEQUENCE = [
Â  { mode:'findTarget', size:4 }, { mode:'findTarget', size:5 }, { mode:'findTarget', size:6 },
Â  { mode:'findDifferent', size:4 }, { mode:'findDifferent', size:5 }, { mode:'findDifferent', size:6 },
Â  { mode:'findMissing', size:4 }, { mode:'findMissing', size:5 }, { mode:'findMissing', size:6 },
Â  // repeat or add more levels
Â  { mode:'findTarget', size:6 }, { mode:'findDifferent', size:6 }, { mode:'findMissing', size:6 },
Â  { mode:'findTarget', size:7 }, { mode:'findDifferent', size:7 }, { mode:'findMissing', size:7 }
];
let seqIndex = 0;

/* Utils */
function shuffle(arr){
Â  const a = arr.slice();
Â  for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
Â  return a;
}
function speak(text, opts={rate:0.85,pitch:1.2}) {
Â  try{
Â  Â  if('speechSynthesis' in window){
Â  Â  Â  window.speechSynthesis.cancel();
Â  Â  Â  const u = new SpeechSynthesisUtterance(text);
Â  Â  Â  u.lang='en-US'; u.rate = opts.rate; u.pitch = opts.pitch;
Â  Â  Â  window.speechSynthesis.speak(u);
Â  Â  }
Â  }catch(e){ console.warn('TTS fail',e) }
}
function colsClass(n){ if(n<=2) return 'cols-2'; if(n<=6) return 'cols-3'; return 'cols-4' }
function clearBoardBelowInstructions(){ while(instructionsEl.nextSibling) instructionsEl.nextSibling.remove(); }

/* star burst */
function starBurst(el){
Â  for(let i=0;i<6;i++){
Â  Â  const s = document.createElement('div');
Â  Â  s.className='star'; s.textContent='â­';
Â  Â  s.style.left='50%'; s.style.top='50%';
Â  Â  const tx=(Math.random()*160-80)+'px', ty=(Math.random()*140-70)+'px';
Â  Â  s.style.setProperty('--tx',tx); s.style.setProperty('--ty',ty);
Â  Â  el.appendChild(s);
Â  Â  requestAnimationFrame(()=> s.classList.add('animate'));
Â  Â  setTimeout(()=> s.remove(),950);
Â  }
}

/* Glow helper for tutorial (flash element for a few times) */
async function flashElements(els, times=2, interval=450){
Â  for(let t=0;t<times;t++){
Â  Â  els.forEach(e=> e.classList.add('glow'));
Â  Â  await new Promise(r=> setTimeout(r, interval));
Â  Â  els.forEach(e=> e.classList.remove('glow'));
Â  Â  await new Promise(r=> setTimeout(r, 140));
Â  }
}

/* ====== Mode renderers and logic ====== */

function renderGrid(emojis, clickable=true, correct=null){
Â  clearBoardBelowInstructions();
Â  const grid = document.createElement('div');
Â  grid.className = 'grid ' + colsClass(emojis.length);
Â  emojis.forEach((em, idx)=>{
Â  Â  const s = document.createElement('div');
Â  Â  s.className='slot';
Â  Â  s.textContent = em;
Â  Â  if(clickable && em!=='â“'){
Â  Â  Â  s.onclick = ()=> {
Â  Â  Â  Â  if(isWaiting) return;
Â  Â  Â  Â  if(correct !== null && em === correct){
Â  Â  Â  Â  Â  isWaiting = true;
Â  Â  Â  Â  Â  s.classList.add('correct'); starBurst(s);
Â  Â  Â  Â  Â  speak(POS[Math.floor(Math.random()*POS.length)], {rate:0.95,pitch:1.3});
Â  Â  Â  Â  Â  score += 10; scoreEl.textContent = score;
Â  Â  Â  Â  Â  setTimeout(()=> { isWaiting=false; nextLevel(); }, 1200);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  s.classList.add('wrong'); speak('Try again', {rate:0.95,pitch:1.05});
Â  Â  Â  Â  Â  setTimeout(()=> s.classList.remove('wrong'), 700);
Â  Â  Â  Â  }
Â  Â  Â  };
Â  Â  }
Â  Â  grid.appendChild(s);
Â  });
Â  board.appendChild(grid);
}

function renderOptions(opts, correct){
Â  // remove previous options
Â  const prev = board.querySelector('.options'); if(prev) prev.remove();
Â  const wrap = document.createElement('div'); wrap.className='options';
Â  opts.forEach(o=>{
Â  Â  const d = document.createElement('div'); d.className='option'; d.textContent=o;
Â  Â  d.onclick = ()=> {
Â  Â  Â  if(isWaiting) return;
Â  Â  Â  if(o === correct){
Â  Â  Â  Â  // fill blank
Â  Â  Â  Â  const blanks = board.querySelectorAll('.slot.blank');
Â  Â  Â  Â  if(blanks.length) {
Â  Â  Â  Â  Â  const blank = blanks[0];
Â  Â  Â  Â  Â  blank.textContent = o; blank.classList.add('correct'); starBurst(blank);
Â  Â  Â  Â  }
Â  Â  Â  Â  isWaiting = true;
Â  Â  Â  Â  speak(POS[Math.floor(Math.random()*POS.length)], {rate:0.95,pitch:1.3});
Â  Â  Â  Â  score += 10; scoreEl.textContent = score;
Â  Â  Â  Â  setTimeout(()=> { isWaiting=false; nextLevel(); }, 1200);
Â  Â  Â  } else {
Â  Â  Â  Â  d.animate([{transform:'translateY(0)'},{transform:'translateX(-8px)'},{transform:'translateX(8px)'},{transform:'translateY(0)'}],{duration:450});
Â  Â  Â  Â  speak('Try again', {rate:0.95,pitch:1.05});
Â  Â  Â  }
Â  Â  };
Â  Â  wrap.appendChild(d);
Â  });
Â  board.appendChild(wrap);
}

/* ----- Specific mode setups ----- */

async function setupFindTarget(size){
Â  const pool = shuffle(ALL).slice(0, size);
Â  const target = pool[Math.floor(Math.random()*pool.length)];
Â  instructionsEl.textContent = `Find the ${target}`;
Â  speak(`Find the ${target}`, {rate:0.82,pitch:1.25});
Â  renderGrid(pool, true, target);

Â  // show a short tutorial first time
Â  if(!tutorialShown.findTarget){
Â  Â  tutorialShown.findTarget = true;
Â  Â  // flash target slot quickly
Â  Â  await new Promise(r=>setTimeout(r,550));
Â  Â  const slots = Array.from(board.querySelectorAll('.slot'));
Â  Â  const targetSlots = slots.filter(s => s.textContent===target);
Â  Â  if(targetSlots.length){
Â  Â  Â  await flashElements(targetSlots.slice(0,1), 3, 430);
Â  Â  }
Â  }
}

async function setupFindDifferent(size){
Â  // pick repeat and a different
Â  const pool = shuffle(ALL);
Â  const repeat = pool[0];
Â  const different = pool.find(e=> e!==repeat);
Â  const arr = new Array(size-1).fill(repeat).concat([different]);
Â  const placed = shuffle(arr);

Â  instructionsEl.textContent = 'Find the different item';
Â  speak('Find the different item', {rate:0.82,pitch:1.25});
Â  renderGrid(placed, true, different);

Â  if(!tutorialShown.findDifferent){
Â  Â  tutorialShown.findDifferent = true;
Â  Â  await new Promise(r=>setTimeout(r,600));
Â  Â  const slots = Array.from(board.querySelectorAll('.slot'));
Â  Â  // find indices
Â  Â  const sameSlots = slots.filter(s => s.textContent === repeat);
Â  Â  const diffSlot = slots.find(s => s.textContent === different);
Â  Â  // flash same ones then flash diff one brightly
Â  Â  await flashElements(sameSlots.slice(0, Math.min(4, sameSlots.length)), 2, 380);
Â  Â  await new Promise(r=>setTimeout(r,200));
Â  Â  if(diffSlot) await flashElements([diffSlot], 4, 400);
Â  }
}

async function setupFindMissing(totalSlots){
Â  // choose distinct emojis
Â  const pool = shuffle(ALL).slice(0, totalSlots);
Â  // pick missing index
Â  const missingIndex = Math.floor(Math.random()*totalSlots);
Â  const missingEmoji = pool[missingIndex];
Â  // prepare display with blank
Â  const display = pool.slice(); display[missingIndex] = 'â“';

Â  instructionsEl.textContent = 'Which emoji is missing?';
Â  speak('Which emoji is missing? Choose the right one to fill the blank!', {rate:0.82,pitch:1.28});
Â  renderGrid(display, false, null); // slots not clickable in missing mode

Â  // Options must include: missingEmoji + two emojis that ARE visible in the grid (so exactly one correct)
Â  const visible = pool.filter((_,i)=>i!==missingIndex);
Â  const twoVisible = shuffle(visible).slice(0,2);
Â  const options = shuffle([missingEmoji, ...twoVisible]);
Â  renderOptions(options, missingEmoji);

Â  if(!tutorialShown.findMissing){
Â  Â  tutorialShown.findMissing = true;
Â  Â  // tutorial: highlight blank then highlight options and show missing
Â  Â  await new Promise(r=>setTimeout(r,600));
Â  Â  const blank = board.querySelector('.slot.blank');
Â  Â  if(blank) await flashElements([blank], 3, 420);
Â  Â  // then highlight the correct option
Â  Â  const optionEls = Array.from(board.querySelectorAll('.option'));
Â  Â  const correctOpt = optionEls.find(o => o.textContent === missingEmoji);
Â  Â  const visibleOptEls = optionEls.filter(o => twoVisible.includes(o.textContent));
Â  Â  // flash visible ones (grey)
Â  Â  await flashElements(visibleOptEls.slice(0,2), 2, 300);
Â  Â  await new Promise(r=>setTimeout(r,180));
Â  Â  if(correctOpt) await flashElements([correctOpt], 3, 420);
Â  }
}

/* ===== Next level controller (deterministic) ===== */
function nextLevel(){
Â  clearBoardBelowInstructions();
Â  const cur = LEVEL_SEQUENCE[seqIndex % LEVEL_SEQUENCE.length];
Â  levelLabel.textContent = `Level ${seqIndex + 1}`;
Â  // decide grid size and mode
Â  if(cur.mode === 'findTarget') setupFindTarget(cur.size);
Â  else if(cur.mode === 'findDifferent') setupFindDifferent(cur.size);
Â  else if(cur.mode === 'findMissing') setupFindMissing(cur.size);
Â  // advance indexes / level counters
Â  seqIndex++;
}

/* --- TTS & Audio Helpers --- */
function base64ToArrayBuffer(base64) {
Â  const binaryString = window.atob(base64);
Â  const len = binaryString.length;
Â  const bytes = new Uint8Array(len);
Â  for (let i = 0; i < len; i++) {
Â  Â  bytes[i] = binaryString.charCodeAt(i);
Â  }
Â  return bytes.buffer;
}

function pcmToWav(pcmData, sampleRate) {
Â  const numChannels = 1;
Â  const sampleSize = 16;
Â  const numFrames = pcmData.length;
Â  const byteRate = sampleRate * numChannels * (sampleSize / 8);
Â  const blockAlign = numChannels * (sampleSize / 8);
Â  const subChunk2Size = numFrames * numChannels * (sampleSize / 8);
Â  const chunkSize = 36 + subChunk2Size;

Â  const buffer = new ArrayBuffer(chunkSize + 8);
Â  const view = new DataView(buffer);

Â  // RIFF identifier
Â  view.setUint32(0, 0x52494646, true);
Â  // file size
Â  view.setUint32(4, chunkSize, true);
Â  // WAVE identifier
Â  view.setUint32(8, 0x57415645, true);
Â  // fmt chunk
Â  view.setUint32(12, 0x666d7420, true);
Â  // sub-chunk size
Â  view.setUint32(16, 16, true);
Â  // audio format (1 = PCM)
Â  view.setUint16(20, 1, true);
Â  // number of channels
Â  view.setUint16(22, numChannels, true);
Â  // sample rate
Â  view.setUint32(24, sampleRate, true);
Â  // byte rate
Â  view.setUint32(28, byteRate, true);
Â  // block align
Â  view.setUint16(32, blockAlign, true);
Â  // bits per sample
Â  view.setUint16(34, sampleSize, true);
Â  // data chunk
Â  view.setUint32(36, 0x64617461, true);
Â  // data size
Â  view.setUint32(40, subChunk2Size, true);

Â  // write the PCM data
Â  let offset = 44;
Â  for (let i = 0; i < numFrames; i++) {
Â  Â  view.setInt16(offset, pcmData[i], true);
Â  Â  offset += 2;
Â  }

Â  return new Blob([view], { type: 'audio/wav' });
}

async function fetchAndPlayWelcomeAudio() {
Â  audioLoadingSpinner.style.display = 'block';
Â  try {
Â  Â  const payload = {
Â  Â  Â  contents: [{
Â  Â  Â  Â  parts: [{ text: "Welcome to Logic Puzzle! Tap the shiny button to start the game." }]
Â  Â  Â  }],
Â  Â  Â  generationConfig: {
Â  Â  Â  Â  responseModalities: ["AUDIO"],
Â  Â  Â  Â  speechConfig: {
Â  Â  Â  Â  Â  voiceConfig: {
Â  Â  Â  Â  Â  Â  prebuiltVoiceConfig: { voiceName: "Puck" }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  model: "gemini-2.5-flash-preview-tts"
Â  Â  };
Â  Â  const apiKey = "";
Â  Â  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

Â  Â  const response = await fetch(apiUrl, {
Â  Â  Â  method: 'POST',
Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  body: JSON.stringify(payload)
Â  Â  });
Â  Â  const result = await response.json();
Â  Â  const part = result?.candidates?.[0]?.content?.parts?.[0];
Â  Â  const audioData = part?.inlineData?.data;
Â  Â  const mimeType = part?.inlineData?.mimeType;

Â  Â  if (audioData && mimeType && mimeType.startsWith("audio/")) {
Â  Â  Â  const sampleRateMatch = mimeType.match(/rate=(\d+)/);
Â  Â  Â  const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
Â  Â  Â  const pcmData = base64ToArrayBuffer(audioData);
Â  Â  Â  const pcm16 = new Int16Array(pcmData);
Â  Â  Â  const wavBlob = pcmToWav(pcm16, sampleRate);
Â  Â  Â  const audioUrl = URL.createObjectURL(wavBlob);
Â  Â  Â  welcomeAudio.src = audioUrl;
Â  Â  Â  welcomeAudio.play().catch(e => console.warn("Audio playback failed:", e));
Â  Â  } else {
Â  Â  Â  console.error("Failed to get valid audio data from API.");
Â  Â  Â  speak("Welcome to Logic Puzzle! Tap the shiny button to start the game.", { rate: 0.85, pitch: 1.2 });
Â  Â  }
Â  } catch (e) {
Â  Â  console.error("Error fetching audio:", e);
Â  Â  speak("Welcome to Logic Puzzle! Tap the shiny button to start the game.", { rate: 0.85, pitch: 1.2 });
Â  } finally {
Â  Â  audioLoadingSpinner.style.display = 'none';
Â  }
}


/* ===== Controls & initialization ===== */
startGameBtn.addEventListener('click', ()=>{
Â  splashScreen.style.display = 'none';
Â  gameBoard.style.display = 'flex';
Â  try{ bgAudio.currentTime = 0; bgAudio.play().catch(()=>{}); }catch(e){}
Â  level = 1; score = 0; seqIndex = 0; scoreEl.textContent = score;
Â  tutorialShown = { findDifferent:false, findMissing:false, findTarget:false };
Â  speak('Letâ€™s play! I will speak slowly and clearly â€” listen carefully!', {rate:0.8,pitch:1.35});
Â  setTimeout(()=> nextLevel(), 700);
});

restartBtn.addEventListener('click', ()=>{
Â  window.speechSynthesis.cancel();
Â  try{ bgAudio.pause(); bgAudio.currentTime = 0; }catch(e){}
Â  level = 1; score = 0; seqIndex = 0; scoreEl.textContent = score;
Â  tutorialShown = { findDifferent:false, findMissing:false, findTarget:false };
Â  instructionsEl.textContent = 'Restartingâ€¦';
Â  setTimeout(()=> { speak('Restarting!'); nextLevel(); }, 500);
});

exitBtn.addEventListener('click', ()=>{
Â  try{ bgAudio.pause(); }catch(e){}
Â  window.location.href = 'index.html';
});

/* init */
window.onload = () => {
Â  splashScreen.style.display = 'flex';
Â  gameBoard.style.display = 'none';
Â  instructionsEl.textContent = 'Tap Start to play!';
Â  levelLabel.textContent = 'Level 1';
Â  scoreEl.textContent = '0';
Â  fetchAndPlayWelcomeAudio();
};

</script>
</body>
</html>
