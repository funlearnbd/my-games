<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kids Logic Adventure</title>
<style>
body {
  font-family: 'Comic Sans MS', cursive, sans-serif;
  margin:0; padding:0; display:flex; justify-content:center; align-items:center;
  height:100vh; background: linear-gradient(135deg, #ffe6f0, #b3e5fc, #c8e6c9);
  overflow:hidden;
}
.container {
  background: rgba(255, 245, 157, 0.95);
  border-radius: 25px; padding:15px;
  width:100%; max-width:600px; min-height:100vh;
  text-align:center; box-shadow:0 8px 20px rgba(0,0,0,0.15);
  box-sizing:border-box;
  position:relative;
}
h1 {margin:10px 0;color:#d81b60;font-size:2rem;}
.emoji-grid, .options-grid {
  display:grid; gap:12px; margin:20px 10px;
}
.emoji-grid {grid-template-columns: repeat(auto-fit, minmax(100px,1fr));}
.options-grid {grid-template-columns: repeat(3,1fr);}
.emoji-item {
  background:#fff3e0; border-radius:15px; cursor:pointer; 
  padding:12px; display:flex; justify-content:center; align-items:center; 
  border:3px solid #6d4c41; font-size:4rem; aspect-ratio:1/1;
  transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
  position:relative;
}
.emoji-item.correct {animation: sparkle 1s ease-out;}
.emoji-item.incorrect {animation: shake 0.5s ease-out;}
@keyframes sparkle {
  0%{transform:scale(1); box-shadow:0 0 0 #ffd700;}
  50%{transform:scale(1.3); box-shadow:0 0 15px 8px rgba(255,215,0,0.7);}
  100%{transform:scale(1); box-shadow:0 0 0 transparent;}
}
@keyframes shake {
  0%,100%{transform:translateX(0);}
  25%{transform:translateX(-8px);}
  75%{transform:translateX(8px);}
}
.exit-btn,.start-btn {
  background:#ff4081;color:white;font-weight:bold;
  padding:10px 20px;border-radius:12px;border:none;
  cursor:pointer;font-size:1.5rem;margin:10px;
  animation: shine 1.5s infinite alternate;
}
@keyframes shine {
  0%{box-shadow:0 0 5px #ff4081;}
  100%{box-shadow:0 0 20px #ffeb3b;}
}
.top-bar {display:flex; justify-content:space-between; align-items:center; padding:0 10px;}
.level-display {color:#0288d1;font-size:1.2rem;font-weight:bold;}
.instructions {font-size:1.4rem;color:#d81b60;margin:10px 0;}
.loading-screen {
  position:absolute;top:0;left:0;width:100%;height:100%;
  background:rgba(255,255,255,0.95);display:flex;
  justify-content:center;align-items:center;flex-direction:column;z-index:999;
}
.loading-text{font-size:2rem;color:#d81b60;margin-bottom:10px;}
.progress-bar {
  width:80%;height:20px;background:#ccc;border-radius:10px;overflow:hidden;margin-top:10px;
}
.progress-fill{height:100%;width:0;background:#ff4081;border-radius:10px;}
</style>
</head>
<body>
<div class="container" id="game-container">
  <h1>Fun Logic Adventure ðŸŒŸ</h1>
  <button class="start-btn" id="start-btn">Start Game</button>
</div>

<audio id="bg-music" loop preload="auto">
  <source src="https://cdn.pixabay.com/audio/2022/03/15/audio_2a9b9d347d.mp3" type="audio/mpeg">
</audio>

<script>
const gameContainer = document.getElementById('game-container');
const startBtn = document.getElementById('start-btn');
const bgMusic = document.getElementById('bg-music');
const imageList = ['apple','ball','banana','car','cat','cherry','dog','fish','flower','orange'];
let images = {}; // Preloaded images
let level = 1, score=0, currentTarget='', maxLevels=50;
let laps=[]; // sequence of challenges
const feedback = ['Super job! ðŸŒŸ','Wow, awesome!','Youâ€™re a star!','Fantastic!','Yay, you did it!'];

// Clear cache at startup for testing
if ('caches' in window) caches.keys().then(keys=>{keys.forEach(k=>caches.delete(k));});

function speak(text, rate=0.9) {
  const synth = window.speechSynthesis;
  const utter = new SpeechSynthesisUtterance(text);
  utter.rate = rate;
  utter.pitch=1.2;
  synth.speak(utter);
}

function preloadImages(callback){
  const loadingOverlay=document.createElement('div');
  loadingOverlay.className='loading-screen';
  const loadingText=document.createElement('div');
  loadingText.className='loading-text'; loadingText.innerText='Loading 0%';
  const progress=document.createElement('div'); progress.className='progress-bar';
  const fill=document.createElement('div'); fill.className='progress-fill';
  progress.appendChild(fill);
  loadingOverlay.appendChild(loadingText); loadingOverlay.appendChild(progress);
  document.body.appendChild(loadingOverlay);

  let loaded=0;
  imageList.forEach(name=>{
    const img=new Image();
    img.src=`image/${name}.png?v=${Date.now()}`;
    img.onload=img.onerror=()=>{
      loaded++; images[name]=img;
      let pct=Math.floor((loaded/imageList.length)*100);
      loadingText.innerText=`Loading ${pct}%`;
      fill.style.width=`${pct}%`;
      if(loaded===imageList.length){
        setTimeout(()=>{loadingOverlay.remove(); callback();},300);
      }
    }
  });
}

function startGame(){
  bgMusic.volume=0.2; bgMusic.play().catch(()=>{});
  level=1; score=0; laps=createLaps();
  nextRound();
}

function createLaps(){
  let arr=[];
  // 10 find item
  for(let i=0;i<10;i++) arr.push('findTarget');
  for(let i=0;i<10;i++) arr.push('findDifferent');
  for(let i=0;i<10;i++) arr.push('findMissing');
  for(let i=0;i<10;i++) arr.push('shadowMatch');
  for(let i=0;i<10;i++) arr.push('patternMatch');
  return arr;
}

function nextRound(){
  gameContainer.innerHTML='';
  if(level>laps.length){
    gameContainer.innerHTML=`<h1>Game Over ðŸŽ‰</h1><p>Your Score: ${score}</p><button class="start-btn" onclick="startGame()">Play Again</button>`;
    speak('Congratulations, you won!');
    return;
  }

  const roundType=laps[level-1];
  const chosen=shuffle([...imageList]).slice(0,6);
  currentTarget=chosen[0];

  const title=document.createElement('h1'); title.innerText='Fun Logic Adventure ðŸŒŸ'; gameContainer.appendChild(title);
  const levelDisp=document.createElement('p'); levelDisp.className='level-display'; levelDisp.innerText=`Level ${level}`; gameContainer.appendChild(levelDisp);

  if(roundType==='findTarget'){
    const instr=document.createElement('p'); instr.className='instructions'; instr.innerText=`Find the ${currentTarget}`;
    gameContainer.appendChild(instr);
    speak(`Find the ${currentTarget}`);
    renderGrid(chosen, currentTarget,'findTarget');
  } else if(roundType==='findDifferent'){
    const instr=document.createElement('p'); instr.className='instructions'; instr.innerText='Find the different item!';
    gameContainer.appendChild(instr);
    // all same except one
    let sameItem=currentTarget;
    let gridItems=new Array(5).fill(sameItem); gridItems.push(shuffle([...imageList].filter(e=>e!==sameItem))[0]);
    gridItems=shuffle(gridItems);
    speak('Find the different item!');
    renderGrid(gridItems, gridItems.find(e=>e!==sameItem),'findDifferent');
  } else if(roundType==='findMissing'){
    const instr=document.createElement('p'); instr.className='instructions'; instr.innerText='Find the missing item!';
    gameContainer.appendChild(instr);
    let missingIndex=Math.floor(Math.random()*6);
    let gridItems=[...chosen]; let answer=gridItems[missingIndex];
    gridItems[missingIndex]='';
    speak('Find the missing item!');
    renderGrid(gridItems, answer,'findMissing',missingIndex);
  } else if(roundType==='shadowMatch'){
    const instr=document.createElement('p'); instr.className='instructions'; instr.innerText='Match the shadow!';
    gameContainer.appendChild(instr);
    let shadowItems=chosen.map(c=>c); let answer=currentTarget;
    renderShadowGrid(shadowItems, answer);
  } else if(roundType==='patternMatch'){
    const instr=document.createElement('p'); instr.className='instructions'; instr.innerText='Find the matching pattern!';
    gameContainer.appendChild(instr);
    renderPatternGrid(chosen, currentTarget);
  }
}

function renderGrid(arr, correct, type, missingIndex=null){
  const grid=document.createElement('div'); grid.className='emoji-grid';
  arr.forEach((name,index)=>{
    const div=document.createElement('div'); div.className='emoji-item';
    if(name!==''){
      div.appendChild(images[name].cloneNode());
      div.onclick=()=>checkAnswer(div,name,correct,type,missingIndex);
    } else div.style.background='#ccc';
    grid.appendChild(div);
  });
  gameContainer.appendChild(grid);
}

function renderShadowGrid(arr, correct){
  const grid=document.createElement('div'); grid.className='emoji-grid';
  arr.forEach(name=>{
    const div=document.createElement('div'); div.className='emoji-item';
    const img=images[name].cloneNode();
    img.style.filter='brightness(0) invert(1)';
    div.appendChild(img);
    div.onclick=()=>checkAnswer(div,name,correct,'shadow');
    grid.appendChild(div);
  });
  gameContainer.appendChild(grid);
}

function renderPatternGrid(arr, correct){
  const grid=document.createElement('div'); grid.className='emoji-grid';
  const targetPattern=correct;
  shuffle(arr).forEach(name=>{
    const div=document.createElement('div'); div.className='emoji-item';
    div.appendChild(images[name].cloneNode());
    div.onclick=()=>checkAnswer(div,name,targetPattern,'pattern');
    grid.appendChild(div);
  });
  gameContainer.appendChild(grid);
}

function checkAnswer(div,name,correct,type,missingIndex){
  if(name===correct){
    div.classList.add('correct');
    const star=document.createElement('div'); star.innerText='ðŸŒŸ'; star.style.position='absolute';
    star.style.top='5px'; star.style.right='5px'; star.style.fontSize='2rem'; div.appendChild(star);
    speak(feedback[Math.floor(Math.random()*feedback.length)],1.1);
    if(type==='findMissing'){
      div.innerHTML=''; div.appendChild(images[correct].cloneNode());
    }
    setTimeout(()=>{level++; nextRound();},1200);
  } else {
    div.classList.add('incorrect');
    speak('Oops, try again!',0.9);
    setTimeout(()=>div.classList.remove('incorrect'),800);
  }
}

function shuffle(arr){return arr.sort(()=>Math.random()-0.5);}
startBtn.onclick=()=>preloadImages(startGame);
</script>
</body>
</html>
