<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>উল্লম্ব যোগ অ্যাডভেঞ্চার</title>
    <style>
        body {
            font-family: 'Noto Sans Bengali', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #74ebd5, #acb6e5);
            margin: 0;
            color: #334e68;
        }

        #game-container {
            text-align: center;
            background-color: #fff;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            min-height: 500px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            animation: fadeIn 1s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        h1 {
            font-size: 2.5em;
            color: #0d47a1;
            margin-top: 0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        #game-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #instructions {
            text-align: left;
            margin-bottom: 20px;
            font-size: 1.1em;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
        }

        #status {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #424242;
        }

        #problem-display {
            font-size: 3em;
            font-weight: bold;
            line-height: 1.2;
            text-align: right;
            margin-bottom: 20px;
            min-width: 200px;
            transition: transform 0.3s ease;
        }

        #problem-display.correct {
            transform: scale(1.1);
            color: #4CAF50;
        }

        #problem-display.wrong {
            animation: shake 0.3s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .problem-line {
            display: block;
        }

        .plus-sign {
            float: left;
            margin-right: 15px;
        }

        .line {
            border-bottom: 4px solid #334e68;
            height: 5px;
            margin-top: 10px;
            margin-bottom: 20px;
        }

        #answer-input {
            width: 180px;
            font-size: 1.8em;
            padding: 12px;
            text-align: right;
            border: 2px solid #ccc;
            border-radius: 8px;
            outline: none;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: border-color 0.3s;
        }

        #answer-input:focus {
            border-color: #4CAF50;
        }

        #message {
            margin-top: 20px;
            font-size: 1.4em;
            font-weight: bold;
            min-height: 40px;
        }

        #timer {
            font-size: 1.2em;
            color: #ff5722;
            margin-bottom: 10px;
        }

        #progress-bar-container {
            width: 80%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        #progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.5s ease;
        }

        #start-btn, #submit-btn, #voice-btn {
            padding: 12px 30px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            transition: background-color 0.2s, transform 0.2s;
        }

        #start-btn {
            background-color: #ffb300;
        }

        #voice-btn.listening {
            background-color: #ff5722;
        }

        #start-btn:hover, #submit-btn:hover, #voice-btn:hover {
            transform: scale(1.05);
        }

        #controls {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .btn {
            padding: 10px 25px;
            font-size: 1em;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.2s;
        }

        #reset-btn { background-color: #1a73e8; }
        #exit-btn { background-color: #f44336; }
        .btn:hover { transform: scale(1.05); }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="game-container">
        <h1>উল্লম্ব যোগ অ্যাডভেঞ্চার</h1>
        <div id="game-content">
            <div id="status"></div>
            <div id="instructions">
                <p>উল্লম্ব যোগ অ্যাডভেঞ্চারে স্বাগতম!</p>
                <p>কীভাবে খেলবেন:</p>
                <ul>
                    <li>উল্লম্বভাবে দেখানো তিনটি সংখ্যা যোগ করুন।</li>
                    <li>উত্তর টাইপ করুন এবং <strong>এন্টার</strong> বা <strong>জমা দিন</strong> টিপুন।</li>
                    <li>অথবা কণ্ঠ ব্যবহার করুন: বলুন "এর যোগফল কত?" এরপর তিনটি সংখ্যা।</li>
                    <li>সময়সীমার মধ্যে উত্তর দিন পয়েন্ট অর্জন করতে!</li>
                    <li>১০টি প্রশ্ন সম্পন্ন করুন লেভেল আপ করতে। উচ্চতর লেভেলে বড় সংখ্যা!</li>
                    <li>গতি এবং নির্ভুলতার জন্য বোনাস পয়েন্ট অর্জন করুন।</li>
                </ul>
            </div>
            <div id="timer"></div>
            <div id="progress-bar-container">
                <div id="progress-bar"></div>
            </div>
            <div id="problem-display"></div>
            <input type="number" id="answer-input" placeholder="উত্তর">
            <div id="message"></div>
        </div>
        <button id="start-btn">খেলা শুরু করুন</button>
        <div id="controls" style="display: none;">
            <button id="voice-btn">কণ্ঠ ইনপুট</button>
            <button id="reset-btn" class="btn">রিসেট</button>
            <button id="exit-btn" class="btn">প্রস্থান</button>
        </div>
    </div>

    <audio id="correct-sound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3"></audio>
    <audio id="wrong-sound" src="https://www.soundjay.com/buttons/sounds/button-4.mp3"></audio>
    <audio id="level-up-sound" src="https://www.soundjay.com/misc/sounds/magic-chime-01.mp3"></audio>

    <script>
        let currentLevel = 1;
        let currentQuestion = 1;
        let score = 0;
        let correctAnswer;
        let timerInterval;
        let timeLeft;
        let recognition;
        const questionsPerLevel = 10;
        const totalLevels = 300;
        const baseTimeLimit = 15; // seconds per question
        const banglaNumerals = ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'];

        // DOM elements
        let gameContent = document.getElementById('game-content');
        const startBtn = document.getElementById('start-btn');
        const controls = document.getElementById('controls');
        let timerDisplay = document.getElementById('timer');
        let progressBarContainer = document.getElementById('progress-bar-container');
        let progressBar = document.getElementById('progress-bar');
        let problemDisplay = document.getElementById('problem-display');
        let messageDisplay = document.getElementById('message');
        let answerInput = document.getElementById('answer-input');
        const correctSound = document.getElementById('correct-sound');
        const wrongSound = document.getElementById('wrong-sound');
        const levelUpSound = document.getElementById('level-up-sound');

        // Convert number to Bangla numerals
        function toBanglaNumerals(num) {
            return num.toString().split('').map(digit => banglaNumerals[parseInt(digit)]).join('');
        }

        startBtn.addEventListener('click', startGame);
        document.getElementById('reset-btn').addEventListener('click', resetGame);
        document.getElementById('exit-btn').addEventListener('click', exitGame);

        // Initialize Speech Recognition
        window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (window.SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'bn-BD';

            const voiceBtn = document.getElementById('voice-btn');
            voiceBtn.addEventListener('click', toggleVoiceInput);

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.toLowerCase();
                voiceBtn.classList.remove('listening');
                voiceBtn.textContent = 'কণ্ঠ ইনপুট';
                processVoiceInput(transcript);
            };

            recognition.onerror = (event) => {
                voiceBtn.classList.remove('listening');
                voiceBtn.textContent = 'কণ্ঠ ইনপুট';
                messageDisplay.textContent = 'কণ্ঠ শনাক্তকরণে ত্রুটি। আবার চেষ্টা করুন।';
                messageDisplay.style.color = 'red';
                speak('কণ্ঠ শনাক্তকরণে ত্রুটি। দয়া করে আবার চেষ্টা করুন।');
            };

            recognition.onend = () => {
                voiceBtn.classList.remove('listening');
                voiceBtn.textContent = 'কণ্ঠ ইনপুট';
            };
        } else {
            document.getElementById('voice-btn').style.display = 'none';
            console.log('Speech Recognition not supported in this browser.');
        }

        function toggleVoiceInput() {
            const voiceBtn = document.getElementById('voice-btn');
            if (!voiceBtn.classList.contains('listening')) {
                voiceBtn.classList.add('listening');
                voiceBtn.textContent = 'শুনছে...';
                recognition.start();
            } else {
                voiceBtn.classList.remove('listening');
                voiceBtn.textContent = 'কণ্ঠ ইনপুট';
                recognition.stop();
            }
        }

        function processVoiceInput(transcript) {
            const pattern = /এর যোগফল কত.*?\s+(\d+)\s+(\d+)\s+(\d+)/i;
            const match = transcript.match(pattern);
            if (match) {
                const num1 = parseInt(match[1], 10);
                const num2 = parseInt(match[2], 10);
                const num3 = parseInt(match[3], 10);
                const playerAnswer = num1 + num2 + num3;
                checkAnswer(playerAnswer);
            } else {
                messageDisplay.textContent = 'দয়া করে "এর যোগফল কত?" বলুন এবং তিনটি সংখ্যা দিন।';
                messageDisplay.style.color = 'red';
                speak('দয়া করে "এর যোগফল কত?" বলুন এবং তিনটি সংখ্যা দিন।');
            }
        }

        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'bn-BD';
            window.speechSynthesis.speak(utterance);
        }

        function startGame() {
            currentLevel = 1;
            currentQuestion = 1;
            score = 0;
            startBtn.style.display = 'none';
            controls.style.display = 'flex';

            // Update DOM references
            gameContent = document.getElementById('game-content');
            timerDisplay = document.getElementById('timer');
            progressBarContainer = document.getElementById('progress-bar-container');
            progressBar = document.getElementById('progress-bar');
            problemDisplay = document.getElementById('problem-display');
            messageDisplay = document.getElementById('message');
            answerInput = document.getElementById('answer-input');

            // Ensure all elements are visible
            document.getElementById('status').style.display = 'block';
            timerDisplay.style.display = 'block';
            progressBarContainer.style.display = 'block';
            problemDisplay.style.display = 'block';
            answerInput.style.display = 'block';

            // Add submit button and event listeners
            let submitBtn = document.getElementById('submit-btn');
            if (!submitBtn) {
                submitBtn = document.createElement('button');
                submitBtn.id = 'submit-btn';
                submitBtn.textContent = 'জমা দিন';
                gameContent.appendChild(submitBtn);
            }
            submitBtn.style.display = 'block';
            submitBtn.addEventListener('click', () => checkAnswer(parseInt(answerInput.value, 10)));
            answerInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') checkAnswer(parseInt(answerInput.value, 10));
            });

            generateProblem();
        }

        function resetGame() {
            clearInterval(timerInterval);
            if (recognition) recognition.stop();
            gameContent.innerHTML = `
                <div id="status"></div>
                <div id="instructions">
                    <p>উল্লম্ব যোগ অ্যাডভেঞ্চারে স্বাগতম!</p>
                    <p>কীভাবে খেলবেন:</p>
                    <ul>
                        <li>উল্লম্বভাবে দেখানো তিনটি সংখ্যা যোগ করুন।</li>
                        <li>উত্তর টাইপ করুন এবং <strong>এন্টার</strong> বা <strong>জমা দিন</strong> টিপুন।</li>
                        <li>অথবা কণ্ঠ ব্যবহার করুন: বলুন "এর যোগফল কত?" এরপর তিনটি সংখ্যা।</li>
                        <li>সময়সীমার মধ্যে উত্তর দিন পয়েন্ট অর্জন করতে!</li>
                        <li>১০টি প্রশ্ন সম্পন্ন করুন লেভেল আপ করতে। উচ্চতর লেভেলে বড় সংখ্যা!</li>
                        <li>গতি এবং নির্ভুলতার জন্য বোনাস পয়েন্ট অর্জন করুন।</li>
                    </ul>
                </div>
                <div id="timer"></div>
                <div id="progress-bar-container">
                    <div id="progress-bar"></div>
                </div>
                <div id="problem-display"></div>
                <input type="number" id="answer-input" placeholder="উত্তর">
                <div id="message"></div>
            `;
            startGame();
        }

        function exitGame() {
            clearInterval(timerInterval);
            if (recognition) recognition.stop();
            gameContent.innerHTML = `<p>খেলা শেষ! চূড়ান্ত স্কোর: ${toBanglaNumerals(score)}। খেলার জন্য ধন্যবাদ!</p>`;
            startBtn.style.display = 'block';
            startBtn.textContent = 'আবার খেলুন';
            controls.style.display = 'none';
        }

        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = Math.max(5, baseTimeLimit - Math.floor(currentLevel / 50));
            timerDisplay.textContent = `সময়: ${toBanglaNumerals(timeLeft)} সেকেন্ড`;
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = `সময়: ${toBanglaNumerals(timeLeft)} সেকেন্ড`;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    messageDisplay.textContent = "সময় শেষ! আবার চেষ্টা করুন।";
                    messageDisplay.style.color = "red";
                    wrongSound.play();
                    speak("সময় শেষ! আবার চেষ্টা করুন।");
                    setTimeout(generateProblem, 1000);
                }
            }, 1000);
        }

        function generateProblem() {
            let num1, num2, num3;
            if (currentLevel <= 50) {
                num1 = Math.floor(Math.random() * 10);
                num2 = Math.floor(Math.random() * 10);
                num3 = Math.floor(Math.random() * 10);
            } else if (currentLevel <= 100) {
                num1 = Math.floor(Math.random() * 50) + 10;
                num2 = Math.floor(Math.random() * 20);
                num3 = Math.floor(Math.random() * 20);
            } else if (currentLevel <= 200) {
                num1 = Math.floor(Math.random() * 90) + 10;
                num2 = Math.floor(Math.random() * 50) + 10;
                num3 = Math.floor(Math.random() * 50);
            } else {
                num1 = Math.floor(Math.random() * 900) + 100;
                num2 = Math.floor(Math.random() * 900) + 100;
                num3 = Math.floor(Math.random() * 900) + 100;
            }

            correctAnswer = num1 + num2 + num3;
            problemDisplay.innerHTML = `
                <span class="problem-line">${toBanglaNumerals(num1)}</span>
                <span class="problem-line">${toBanglaNumerals(num2)}</span>
                <span class="problem-line"><span class="plus-sign">+</span>${toBanglaNumerals(num3)}</span>
                <div class="line"></div>
            `;
            document.getElementById('status').textContent = `লেভেল ${toBanglaNumerals(currentLevel)} | প্রশ্ন ${toBanglaNumerals(currentQuestion)}/${toBanglaNumerals(questionsPerLevel)} | স্কোর: ${toBanglaNumerals(score)}`;
            progressBar.style.width = `${(currentQuestion - 1) / questionsPerLevel * 100}%`;
            messageDisplay.textContent = "";
            problemDisplay.className = "";
            answerInput.value = "";
            answerInput.focus();
            startTimer();
        }

        function checkAnswer(playerAnswer) {
            if (playerAnswer === correctAnswer) {
                clearInterval(timerInterval);
                const timeBonus = Math.max(0, timeLeft * 10);
                score += 100 + timeBonus;
                messageDisplay.textContent = `সঠিক! +${toBanglaNumerals(100 + timeBonus)} পয়েন্ট`;
                messageDisplay.style.color = "green";
                problemDisplay.className = "correct";
                correctSound.play();
                speak("ভালো কাজ!");
                if (currentQuestion < questionsPerLevel) {
                    currentQuestion++;
                    setTimeout(generateProblem, 1000);
                } else if (currentLevel < totalLevels) {
                    messageDisplay.textContent = `লেভেল ${toBanglaNumerals(currentLevel)} সম্পন্ন! স্কোর: ${toBanglaNumerals(score)}`;
                    messageDisplay.style.color = "blue";
                    levelUpSound.play();
                    speak(`লেভেল ${toBanglaNumerals(currentLevel)} সম্পন্ন!`);
                    currentLevel++;
                    currentQuestion = 1;
                    setTimeout(generateProblem, 1500);
                } else {
                    messageDisplay.textContent = `সব লেভেল সম্পন্ন! চূড়ান্ত স্কোর: ${toBanglaNumerals(score)}`;
                    messageDisplay.style.color = "purple";
                    levelUpSound.play();
                    speak("সব লেভেল সম্পন্ন! দারুণ কাজ!");
                    clearInterval(timerInterval);
                    answerInput.style.display = 'none';
                    document.getElementById('submit-btn').style.display = 'none';
                    timerDisplay.style.display = 'none';
                    document.getElementById('voice-btn').style.display = 'none';
                }
            } else {
                messageDisplay.textContent = "আবার চেষ্টা করুন!";
                messageDisplay.style.color = "red";
                problemDisplay.className = "wrong";
                wrongSound.play();
                speak("আবার চেষ্টা করুন!");
            }
        }
    </script>
</body>
</html>