<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kids Logic Quest</title>
<style>
  :root{
    --bg1:#ffecd2; --bg2:#fcb69f; --accent:#3498db; --good:#27ae60; --bad:#e74c3c;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  body{
    display:flex;flex-direction:column;align-items:center;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));padding:10px;
    user-select:none; -webkit-user-select:none; overflow:hidden;
  }
  h1{margin:6px 0 8px;font-size:28px;color:#c0392b;text-shadow:0 1px 0 #fff;}
  #top-bar{width:100%;max-width:820px;display:flex;justify-content:space-between;align-items:center;padding:0 6px;margin-bottom:6px;}
  #score{font-weight:700;color:#2c3e50}
  #question{font-size:20px;margin:6px 0 10px;color:#2c3e50;min-height:44px;text-align:center;max-width:820px;}
  #board{width:100%;max-width:820px;display:flex;flex-direction:column;align-items:center;gap:8px;}
  #puzzle{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;width:100%;max-width:520px;justify-items:center;}
  #grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(96px,1fr));gap:10px;width:100%;max-width:720px;justify-items:center;padding:6px;}
  .answer-box{width:96px;height:96px;border-radius:12px;background:#fff;border:3px solid var(--accent);display:flex;align-items:center;justify-content:center;box-shadow:0 6px 12px rgba(0,0,0,0.12);cursor:pointer;transition:transform .18s,box-shadow .18s;}
  .answer-box img{width:82px;height:82px;object-fit:contain;border-radius:8px;pointer-events:none;display:block;touch-action:none;}
  .answer-box:active{transform:scale(.98);}
  .correct{animation:bounce .55s;border-color:var(--good);box-shadow:0 10px 20px rgba(39,174,96,.15)!important;}
  .wrong{animation:shake .45s;border-color:var(--bad);box-shadow:0 10px 20px rgba(231,76,60,.12)!important;}
  @keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-14px)}60%{transform:translateY(-8px)}}
  @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-8px)}50%{transform:translateX(8px)}75%{transform:translateX(-6px)}100%{transform:translateX(0)}}
  #drop-zone{width:260px;height:110px;border-radius:14px;border:3px dashed #27ae60;background:#eafaf0;display:flex;align-items:center;justify-content:center;color:#2c3e50;font-weight:700;display:none;transition:background .2s,border-color .2s;}
  #drop-zone.drag-over{background:#d4f7dc;border-color:#1eae54;}
  #message{min-height:26px;margin-top:6px;font-weight:700;color:#2c3e50}
  #drag-copy{position:fixed;width:86px;height:86px;pointer-events:none;display:none;z-index:9999;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,0.18);background:#fff;overflow:hidden}
  #drag-copy img{width:86px;height:86px;object-fit:contain;display:block}
  #tutorial-arrow{position:fixed;width:48px;height:48px;display:none;z-index:9998;font-size:36px;line-height:48px;text-align:center}
  .hintPulse{box-shadow:0 0 18px 6px rgba(241,196,15,0.22), inset 0 0 10px rgba(241,196,15,0.12);border-color:#f1c40f!important;}
  @media (max-width:480px){
    .answer-box{width:88px;height:88px}
    .answer-box img{width:74px;height:74px}
    #drop-zone{width:220px;height:96px}
  }
</style>
</head>
<body>
  <div id="top-bar">
    <div id="score">Score: 0</div>
    <div style="font-size:13px;color:#2c3e50">Tip: first two drag rounds show the arrow →</div>
  </div>

  <h1>Kids Logic Quest</h1>
  <div id="question">Loading…</div>

  <div id="board">
    <div id="puzzle"></div>
    <div id="grid"></div>
    <div id="drop-zone">Drag the item here</div>
    <div id="message"></div>
  </div>

  <!-- floating drag image & arrow -->
  <div id="drag-copy"><img alt=""></div>
  <div id="tutorial-arrow">➡️</div>

  <!-- sounds -->
  <audio id="success-sound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
  <audio id="buzz-sound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
// ---------- Inline SVG assets ----------
function svgURI(svg){ return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg); }
const svgs = {
  apple:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="56" r="20" fill="#e74c3c"/><path d="M58 35c6-6 14-6 22-3" fill="none" stroke="#5bbd42" stroke-width="4" stroke-linecap="round"/><rect x="48" y="25" width="4" height="12" rx="1" fill="#6b3e1d"/></svg>`,
  banana:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 80"><path d="M10,60 C30,5 90,5 110,60 C85,70 35,70 10,60" fill="#ffdd57" stroke="#e6c85b" stroke-width="2"/></svg>`,
  dog:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="30" rx="8" ry="8" width="60" height="44" fill="#c4875a"/><circle cx="35" cy="46" r="6" fill="#fff"/><circle cx="65" cy="46" r="6" fill="#fff"/><circle cx="35" cy="46" r="2.5" fill="#000"/><circle cx="65" cy="46" r="2.5" fill="#000"/><rect x="46" y="56" width="8" height="6" rx="3" fill="#5b3a2a"/></svg>`,
  cat:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="28" fill="#9aa6af"/><polygon points="28,32 40,18 46,34" fill="#9aa6af"/><polygon points="72,32 60,18 54,34" fill="#9aa6af"/><circle cx="42" cy="48" r="4" fill="#fff"/><circle cx="58" cy="48" r="4" fill="#fff"/><circle cx="42" cy="48" r="2" fill="#000"/><circle cx="58" cy="48" r="2" fill="#000"/><path d="M40 62 Q50 68 60 62" stroke="#6b6b6b" stroke-width="2" fill="none" stroke-linecap="round"/></svg>`,
  flower:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="40" r="12" fill="#f1c40f"/><circle cx="50" cy="20" r="12" fill="#ff6ea1"/><circle cx="70" cy="35" r="12" fill="#ff6ea1"/><circle cx="30" cy="35" r="12" fill="#ff6ea1"/><circle cx="35" cy="55" r="12" fill="#ff6ea1"/><circle cx="65" cy="55" r="12" fill="#ff6ea1"/><rect x="48" y="55" width="4" height="25" fill="#2ecc71"/></svg>`,
  star:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><polygon points="50,12 61,40 92,40 66,58 76,88 50,70 24,88 34,58 8,40 39,40" fill="#f1c40f"/></svg>`,
  car:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 140 80"><rect x="10" y="30" width="120" height="30" rx="8" fill="#3498db"/><rect x="34" y="12" width="72" height="30" rx="6" fill="#2c82d4"/><circle cx="34" cy="62" r="10" fill="#333"/><circle cx="106" cy="62" r="10" fill="#333"/></svg>`,
  ball:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="30" fill="#e74c3c"/><path d="M20 50 a30 30 0 0 0 60 0" stroke="#fff" stroke-width="3" fill="none"/><circle cx="50" cy="50" r="2" fill="#fff"/></svg>`,
  tree:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="46" y="60" width="8" height="20" fill="#8b5a2b"/><circle cx="50" cy="42" r="20" fill="#2ecc71"/><circle cx="36" cy="50" r="12" fill="#2ecc71"/><circle cx="64" cy="50" r="12" fill="#2ecc71"/></svg>`,
  smile:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="30" fill="#ffd93b"/><circle cx="40" cy="45" r="4" fill="#3d3d3d"/><circle cx="60" cy="45" r="4" fill="#3d3d3d"/><path d="M38 60 Q50 72 62 60" stroke="#3d3d3d" stroke-width="4" fill="none" stroke-linecap="round"/></svg>`
};
const ITEMS = Object.entries(svgs).map(([id,svg]) => ({
  id, name:id, src: svgURI(svg), sound: (id==='dog'?'https://actions.google.com/sounds/v1/animals/dog_bark.ogg':(id==='cat'?'https://actions.google.com/sounds/v1/animals/cat_meow.ogg':'')),
}));

// ---------- State ----------
let score=0, correctId=null, currentMode=null;
let modeCounters = {select:0, drag:0, missing:0, different:0};
let arrowInterval=null;

// ---------- DOM ----------
const questionEl = document.getElementById('question');
const gridEl = document.getElementById('grid');
const puzzleEl = document.getElementById('puzzle');
const dropZoneEl = document.getElementById('drop-zone');
const msgEl = document.getElementById('message');
const scoreEl = document.getElementById('score');
const dragCopy = document.getElementById('drag-copy');
const dragCopyImg = dragCopy.querySelector('img');
const tutorialArrow = document.getElementById('tutorial-arrow');
const successSound = document.getElementById('success-sound');
const buzzSound = document.getElementById('buzz-sound');

// ---------- Utils ----------
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }
function speak(t){ if(!('speechSynthesis' in window))return; try{ const u=new SpeechSynthesisUtterance(t); u.lang='en-US'; u.rate=0.95; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){} }
function decideMode(){
  if(modeCounters.select<2) return 'select';
  if(modeCounters.drag<2) return 'drag';
  if(modeCounters.missing<2) return 'missing';
  if(modeCounters.different<2) return 'different';
  const modes=['select','select','drag','missing','different'];
  return modes[Math.floor(Math.random()*modes.length)];
}
function pointInRect(x,y,rect){ return x>=rect.left && x<=rect.right && y>=rect.top && y<=rect.bottom; }

// ---------- Round Controller ----------
function newRound(){
  msgEl.textContent='';
  gridEl.innerHTML='';
  puzzleEl.innerHTML='';
  dropZoneEl.style.display='none';
  tutorialArrow.style.display='none';
  dragCopy.style.display='none';
  if(arrowInterval){ clearInterval(arrowInterval); arrowInterval=null; }

  currentMode = decideMode();
  if(currentMode==='select'){ modeCounters.select++; generateSelect(); }
  else if(currentMode==='drag'){ modeCounters.drag++; generateDrag(); }
  else if(currentMode==='missing'){ modeCounters.missing++; generateMissing(); }
  else { modeCounters.different++; generateDifferent(); }
}

// ---------- Modes ----------
function generateSelect(){
  const correct = ITEMS[Math.floor(Math.random()*ITEMS.length)];
  correctId = correct.id;
  questionEl.textContent = `Find the ${correct.name}!`; speak(questionEl.textContent);

  let options=[correct];
  while(options.length<6){ const it=ITEMS[Math.floor(Math.random()*ITEMS.length)]; if(!options.find(o=>o.id===it.id)) options.push(it); }
  shuffle(options);

  options.forEach(opt=>makeGridBox(opt, (box)=>handleSelect(opt.id,opt.sound,box)));
  if(modeCounters.select<=2) showHint(correctId);
}

function generateDrag(){
  const correct = ITEMS[Math.floor(Math.random()*ITEMS.length)];
  correctId = correct.id;
  questionEl.textContent = `Drag the ${correct.name} to the box!`; speak(questionEl.textContent);

  dropZoneEl.style.display='flex';
  let options=[correct];
  while(options.length<6){ const it=ITEMS[Math.floor(Math.random()*ITEMS.length)]; if(!options.find(o=>o.id===it.id)) options.push(it); }
  shuffle(options);

  options.forEach(opt=>{
    const box = makeGridBox(opt);
    // enable pointer drag
    enablePointerDrag(box.querySelector('img'), opt.id, opt.sound);
  });

  // tutorial arrow for first 2 drag rounds, pointing to the CORRECT item
  if(modeCounters.drag<=2) showDragArrowLoop();
}

function generateMissing(){
  const seq = shuffle(ITEMS.slice()).slice(0,6);
  const missingIndex = Math.floor(Math.random()*seq.length);
  correctId = seq[missingIndex].id;

  questionEl.textContent='Find the missing piece!'; speak(questionEl.textContent);

  // show 3x2 puzzle, blank on missing cell
  for(let i=0;i<seq.length;i++){
    const shell = document.createElement('div'); shell.className='answer-box';
    if(i!==missingIndex){
      const img=document.createElement('img'); img.src=seq[i].src; img.alt=seq[i].name; img.draggable=false;
      img.addEventListener('dragstart', e=>e.preventDefault());
      shell.appendChild(img);
    } else {
      shell.style.boxShadow='inset 0 0 0 3px rgba(0,0,0,0.06)';
    }
    puzzleEl.appendChild(shell);
  }

  let options=[seq[missingIndex]];
  while(options.length<3){ const it=ITEMS[Math.floor(Math.random()*ITEMS.length)]; if(!options.find(o=>o.id===it.id)) options.push(it); }
  shuffle(options);
  options.forEach(opt=>makeGridBox(opt, (box)=>handleSelect(opt.id,opt.sound,box)));
  if(modeCounters.missing<=2) showHint(correctId);
}

function generateDifferent(){
  const base = ITEMS[Math.floor(Math.random()*ITEMS.length)];
  let diff; do{ diff = ITEMS[Math.floor(Math.random()*ITEMS.length)]; } while(diff.id===base.id);
  correctId = diff.id;

  questionEl.textContent='Find the different item!'; speak(questionEl.textContent);

  const arr=[diff, base, base, base, base, base];
  shuffle(arr);
  arr.forEach(opt=>makeGridBox(opt, (box)=>handleSelect(opt.id,opt.sound,box)));
  if(modeCounters.different<=2) showHint(correctId);
}

// ---------- UI builders ----------
function makeGridBox(opt, onClick){
  const box=document.createElement('div'); box.className='answer-box';
  const img=document.createElement('img');
  img.src=opt.src; img.alt=opt.name; img.dataset.id=opt.id;
  img.draggable=false; img.addEventListener('dragstart', e=>e.preventDefault()); // disable native drag
  box.appendChild(img);
  if(onClick) box.addEventListener('click', ()=>onClick(box));
  gridEl.appendChild(box);
  return box;
}

// ---------- Drag (pointer) ----------
function enablePointerDrag(imgEl, itemId, itemSound){
  imgEl.style.touchAction='none'; // prevent touch scrolling on the element
  imgEl.addEventListener('pointerdown', (e)=>{
    e.preventDefault();
    try{ imgEl.setPointerCapture(e.pointerId); }catch(_){}
    // show floating copy
    dragCopyImg.src = imgEl.src;
    dragCopy.style.display='block';
    moveDragCopy(e.clientX, e.clientY);
    dropZoneEl.classList.remove('drag-over');

    const onMove = (ev)=>{
      moveDragCopy(ev.clientX, ev.clientY);
      const r = dropZoneEl.getBoundingClientRect();
      if(pointInRect(ev.clientX, ev.clientY, r)) dropZoneEl.classList.add('drag-over');
      else dropZoneEl.classList.remove('drag-over');
    };
    const onUp = (ev)=>{
      dragCopy.style.display='none';
      dropZoneEl.classList.remove('drag-over');
      try{ imgEl.releasePointerCapture(e.pointerId); }catch(_){}
      document.removeEventListener('pointermove', onMove);
      document.removeEventListener('pointerup', onUp);
      document.removeEventListener('pointercancel', onUp);
      const r = dropZoneEl.getBoundingClientRect();
      if(pointInRect(ev.clientX, ev.clientY, r)){ handleDrop(itemId, itemSound); }
    };
    document.addEventListener('pointermove', onMove);
    document.addEventListener('pointerup', onUp);
    document.addEventListener('pointercancel', onUp);
  });
}
function moveDragCopy(x,y){
  const off=43;
  dragCopy.style.left=(x-off)+'px';
  dragCopy.style.top=(y-off)+'px';
}

// ---------- Feedback ----------
function handleSelect(selectedId, sound, boxEl){
  const boxes=[...document.querySelectorAll('.answer-box')];
  boxes.forEach(b=>b.classList.remove('correct','wrong','hintPulse'));
  if(selectedId===correctId){
    successSound.currentTime=0; successSound.play();
    if(sound) try{ new Audio(sound).play(); }catch(_){}
    msgEl.textContent='✅ Correct!';
    speak('Correct!');
    score++; scoreEl.textContent='Score: '+score;
    if(boxEl) boxEl.classList.add('correct');
    setTimeout(newRound, 900);
  }else{
    buzzSound.currentTime=0; buzzSound.play();
    msgEl.textContent='❌ Try again!';
    speak('Try again!');
    if(boxEl) boxEl.classList.add('wrong');
  }
}
function handleDrop(selectedId, sound){
  const imgs=[...document.querySelectorAll('.answer-box img')];
  const boxEl = imgs.find(i=>i.dataset.id===selectedId)?.parentElement || null;
  handleSelect(selectedId, sound, boxEl);
}

// ---------- Hints ----------
function showHint(id){
  setTimeout(()=>{
    const img=document.querySelector(`.answer-box img[data-id="${id}"]`);
    if(img && img.parentElement){
      img.parentElement.classList.add('hintPulse');
      setTimeout(()=>img.parentElement.classList.remove('hintPulse'), 1600);
    }
  }, 120);
}

// ---------- Drag Tutorial Arrow (points to CORRECT item) ----------
function showDragArrowLoop(){
  tutorialArrow.style.display='block';
  let t=0;
  if(arrowInterval) clearInterval(arrowInterval);
  arrowInterval = setInterval(()=>{
    const srcImg = document.querySelector(`.answer-box img[data-id="${correctId}"]`);
    if(!srcImg){ tutorialArrow.style.display='none'; return; }
    const sRect = srcImg.getBoundingClientRect();
    const dRect = dropZoneEl.getBoundingClientRect();
    const sx = sRect.left + sRect.width/2;
    const sy = sRect.top + sRect.height/2;
    const dx = dRect.left + dRect.width/2;
    const dy = dRect.top + dRect.height/2;
    const p = (t % 60)/30; // 0->2
    const prog = p<=1 ? p : 2-p; // 0->1->0
    const x = Math.round(sx + (dx-sx)*prog - 24);
    const y = Math.round(sy + (dy-sy)*prog - 24);
    tutorialArrow.style.left = x+'px';
    tutorialArrow.style.top = y+'px';
    t++;
  }, 28);
  setTimeout(()=>{ if(arrowInterval){ clearInterval(arrowInterval); arrowInterval=null; tutorialArrow.style.display='none'; } }, 8000);
}

// ---------- Go ----------
newRound();

// Prevent native image drag globally (desktop browsers)
document.addEventListener('dragstart', e=>e.preventDefault());
</script>
</body>
</html>
