<script>
/* ---------- DATA ---------- */
const imageList = ["apple","ball","banana","car","cat","cherry","dog","fish","flower","orange"];

/* ---------- STATE + DOM ---------- */
let currentMode = "find";
let voicesReady = false;
let score = 0;
let waitingNextRound = false; 
let roundAnswered = false;  

const loadedImages = {};
const bgMusic = document.getElementById('bgMusic');
const correctSound = document.getElementById('correctSound');
const wrongSound = document.getElementById('wrongSound');
const scoreEl = document.getElementById('score');
const startBtn = document.getElementById('startBtn');
const startScreen = document.getElementById('startScreen');
const game = document.getElementById('game');
const qEl = document.getElementById('question');
const optionsEl = document.getElementById('options');
const exitBtn = document.getElementById('exitBtn');

/* preload images */
imageList.forEach(name => { const img = new Image(); img.src = `image/${name}.png`; loadedImages[name] = img; });

/* ---------- START / EXIT ---------- */
startBtn.addEventListener('click', () => {
  voicesReady = true;
  try { bgMusic.play(); } catch(e) {}
  startScreen.style.display = 'none';
  game.style.display = 'block';
  score = 0;
  updateScore();
  nextRound();
});

exitBtn.addEventListener('click', () => {
  try { bgMusic.pause(); bgMusic.currentTime = 0; } catch(e) {}
  window.location.href = 'index.html';
});

/* ---------- SPEECH ---------- */
function speak(text, cb=null){
  if(!voicesReady){ if(cb) setTimeout(cb, 400); return; }
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 0.8; u.pitch = 1.15;
  if(cb) u.onend = cb;
  speechSynthesis.speak(u);
}

/* ---------- SCORE ---------- */
function updateScore(){
  scoreEl.textContent = `Score: ${score}`;
}

/* ---------- UTIL ---------- */
function shuffle(arr){ return arr.slice().sort(()=>Math.random()-0.5); }

/* ---------- CORE FLOW ---------- */
function nextRound(){
  if(waitingNextRound) return;
  roundAnswered = false;
  optionsEl.innerHTML = '';
  const modes = ['find','different','missing','memory','shadow']; // Added new modes
  currentMode = modes[Math.floor(Math.random()*modes.length)];
  if(currentMode==='find') startFindRound();
  else if(currentMode==='different') startDifferentRound();
  else if(currentMode==='missing') startMissingRound();
  else if(currentMode==='memory') startMemoryRound();
  else startShadowRound();
}

function createQuestionTile(name, parent){
  const tile = document.createElement('div');
  tile.className = 'option question-tile';
  const img = document.createElement('img');
  img.src = loadedImages[name].src;
  img.alt = name;
  tile.appendChild(img);
  parent.appendChild(tile);
}

function createAnswerTile(name, isCorrect, parent, blankDiv=null, missing=null){
  const tile = document.createElement('div');
  tile.className = 'option';
  tile.dataset.correct = isCorrect ? '1' : '0';
  const img = document.createElement('img');
  img.src = loadedImages[name].src;
  img.alt = name;
  tile.appendChild(img);

  tile.addEventListener('click', ()=>{
    if(roundAnswered) return; 
    const correct = tile.dataset.correct === '1';
    if(correct){
      roundAnswered = true;
      try{ correctSound.currentTime = 0; correctSound.play(); }catch(e){}
      score++;
      updateScore();
      if(blankDiv && missing){
        blankDiv.innerHTML = '';
        const im = document.createElement('img');
        im.src = loadedImages[missing].src;
        im.alt = missing;
        blankDiv.appendChild(im);
      }
      speak('Well done!', ()=> setTimeout(()=> nextRound(), 500));
    } else {
      try{ wrongSound.currentTime = 0; wrongSound.play(); }catch(e){}
      speak('Try again');
    }
  });
  parent.appendChild(tile);
}

/* ---------- EXISTING ROUNDS ---------- */
function startFindRound(){
  const choices = shuffle(imageList).slice(0,4);
  const target = choices[Math.floor(Math.random()*choices.length)];
  qEl.textContent = `Find the ${target}`;
  speak(`Can you find the ${target}?`);
  const ansContainer = document.createElement('div');
  ansContainer.className = 'answer-container';
  shuffle(choices).forEach(name => createAnswerTile(name, name===target, ansContainer));
  optionsEl.appendChild(ansContainer);
}

function startDifferentRound(){
  const base = imageList[Math.floor(Math.random()*imageList.length)];
  let odd;
  do{ odd = imageList[Math.floor(Math.random()*imageList.length)]; } while(odd === base);
  qEl.textContent = 'Find the different one!';
  speak('Which one is different?');
  const arr = shuffle([base, base, base, odd]);
  const ansContainer = document.createElement('div');
  ansContainer.className = 'answer-container';
  arr.forEach(name => createAnswerTile(name, name===odd, ansContainer));
  optionsEl.appendChild(ansContainer);
}

function startMissingRound(){
  const selected = shuffle(imageList).slice(0, 6);
  const missingIndex = Math.floor(Math.random() * selected.length);
  const missing = selected[missingIndex];
  const itemsInGrid = selected.filter((_, idx) => idx !== missingIndex);

  qEl.textContent = 'Which picture is missing?';
  speak('Which picture is missing?');

  const questionContainer = document.createElement('div');
  questionContainer.className = 'option-container';

  let blankDiv = null;
  selected.forEach((name, idx) => {
    if(idx === missingIndex){
      blankDiv = document.createElement('div');
      blankDiv.className = 'option blank';
      questionContainer.appendChild(blankDiv);
    } else {
      createQuestionTile(name, questionContainer);
    }
  });
  optionsEl.appendChild(questionContainer);

  const wrongOptions = shuffle(itemsInGrid).slice(0, 2);
  const answerChoices = shuffle([missing, ...wrongOptions]);

  const answerContainer = document.createElement('div');
  answerContainer.className = 'answer-container';
  answerChoices.forEach(name =>
    createAnswerTile(name, name === missing, answerContainer, blankDiv, missing)
  );
  optionsEl.appendChild(answerContainer);
}

/* ---------- NEW GAME 1: MEMORY MATCH ---------- */
function startMemoryRound(){
  qEl.textContent = "Find all matching pairs!";
  speak("Can you match the pairs?");
  
  const picks = shuffle(imageList).slice(0,3);
  const pairs = shuffle([...picks, ...picks]);
  
  const container = document.createElement('div');
  container.className = 'option-container';
  
  let flipped = [];
  let matched = 0;

  pairs.forEach(name => {
    const card = document.createElement('div');
    card.className = 'option blank';
    card.textContent = "?";
    card.dataset.name = name;
    card.addEventListener('click', () => {
      if(card.classList.contains('matched') || flipped.includes(card)) return;
      card.innerHTML = `<img src="${loadedImages[name].src}" alt="${name}">`;
      flipped.push(card);
      if(flipped.length === 2){
        if(flipped[0].dataset.name === flipped[1].dataset.name){
          flipped.forEach(c => c.classList.add('matched'));
          matched++;
          score++;
          updateScore();
          flipped = [];
          if(matched === picks.length){
            speak("Great job!", ()=> setTimeout(()=> nextRound(), 700));
          }
        } else {
          setTimeout(()=>{
            flipped.forEach(c => { c.innerHTML="?"; });
            flipped=[];
          }, 800);
        }
      }
    });
    container.appendChild(card);
  });
  optionsEl.appendChild(container);
}

/* ---------- NEW GAME 2: SHADOW MATCH ---------- */
function startShadowRound(){
  const choices = shuffle(imageList).slice(0,3);
  qEl.textContent = "Match picture to its shadow!";
  speak("Can you match the picture to its shadow?");

  const questionContainer = document.createElement('div');
  questionContainer.className = 'option-container';
  
  // show shadows (grayscale)
  choices.forEach(name => {
    const div = document.createElement('div');
    div.className = 'option blank';
    const img = document.createElement('img');
    img.src = loadedImages[name].src;
    img.style.filter = "grayscale(100%) contrast(200%) brightness(50%)";
    img.alt = "shadow";
    div.appendChild(img);
    div.dataset.name = name;
    questionContainer.appendChild(div);
  });
  optionsEl.appendChild(questionContainer);
  
  // answer choices with colors
  const answerContainer = document.createElement('div');
  answerContainer.className = 'answer-container';
  choices.forEach(name => {
    createAnswerTile(name, true, answerContainer);
  });
  // attach custom matching logic
  [...answerContainer.children].forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const pick = btn.querySelector("img").alt;
      const shadow = [...questionContainer.children].find(s=>s.dataset.name===pick);
      if(shadow){
        shadow.style.opacity="0.3";
        btn.style.opacity="0.3";
        score++;
        updateScore();
        if([...questionContainer.children].every(s=>s.style.opacity==="0.3")){
          speak("Excellent!", ()=> setTimeout(()=> nextRound(), 700));
        }
      }
    });
  });
  optionsEl.appendChild(answerContainer);
}
</script>
