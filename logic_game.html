<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kids Logic Game — Fixed Images & Mobile Drag</title>
<style>
  :root{
    --bg1: #ffecd2;
    --bg2: #fcb69f;
    --accent: #3498db;
    --good: #27ae60;
    --bad: #e74c3c;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;}
  body{
    display:flex;flex-direction:column;align-items:center;
    background: linear-gradient(135deg,var(--bg1),var(--bg2));padding:12px 10px;
    -webkit-user-select:none;user-select:none;overflow:hidden;
  }
  h1{margin:6px 0 8px;font-size:28px;color:#c0392b;text-shadow:0 1px 0 #fff;}
  #top-bar{width:100%;max-width:820px;display:flex;justify-content:space-between;align-items:center;padding:0 6px;margin-bottom:6px;}
  #score{font-weight:700;color:#2c3e50}
  #question{font-size:20px;margin:6px 0 10px;color:#2c3e50;min-height:44px;text-align:center;max-width:820px;}
  #board{width:100%;max-width:820px;display:flex;flex-direction:column;align-items:center;gap:8px;}
  #puzzle {display:grid;grid-template-columns:repeat(3,1fr);gap:8px;width:100%;max-width:520px;justify-items:center;}
  #grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(96px,1fr));gap:10px;width:100%;max-width:720px;justify-items:center;padding:6px 6px;}
  .answer-box{width:96px;height:96px;border-radius:12px;background:#fff;border:3px solid var(--accent);display:flex;align-items:center;justify-content:center;box-shadow:0 6px 12px rgba(0,0,0,0.12);cursor:pointer;transition:transform .18s,box-shadow .18s;}
  .answer-box img{width:82px;height:82px;object-fit:contain;border-radius:8px;pointer-events:none;display:block;}
  .answer-box:active{transform:scale(.98);}
  .correct{animation:bounce .55s; border-color:var(--good); box-shadow:0 10px 20px rgba(39,174,96,.15) !important;}
  .wrong{animation:shake .45s; border-color:var(--bad); box-shadow:0 10px 20px rgba(231,76,60,.12) !important;}
  @keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-14px)}60%{transform:translateY(-8px)}}
  @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-8px)}50%{transform:translateX(8px)}75%{transform:translateX(-6px)}100%{transform:translateX(0)}}
  #drop-zone{width:260px;height:110px;border-radius:14px;border:3px dashed #27ae60;background:#eafaf0;display:flex;align-items:center;justify-content:center;color:#2c3e50;font-weight:700;display:none}
  #message{min-height:26px;margin-top:6px;font-weight:700;color:#2c3e50}
  #drag-copy{position:fixed;width:86px;height:86px;pointer-events:none;display:none;z-index:9999;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,0.18);background:#fff;overflow:hidden}
  #tutorial-arrow{position:fixed;width:48px;height:48px;display:none;z-index:9998;font-size:36px;line-height:48px;text-align:center}
  .hintPulse{box-shadow:0 0 18px 6px rgba(241,196,15,0.22), inset 0 0 10px rgba(241,196,15,0.12);border-color:#f1c40f !important;}
  /* responsive tweaks */
  @media (max-width:480px){
    .answer-box{width:88px;height:88px}
    .answer-box img{width:74px;height:74px}
    #drop-zone{width:220px;height:96px}
  }
</style>
</head>
<body>
  <div id="top-bar">
    <div id="score">Score: 0</div>
    <div style="font-size:13px;color:#2c3e50">Tip: first two drag rounds show the arrow →</div>
  </div>

  <h1>Kids Logic Quest</h1>
  <div id="question">Loading…</div>

  <div id="board">
    <div id="puzzle"></div>
    <div id="grid"></div>
    <div id="drop-zone">Drag the item here</div>
    <div id="message"></div>
  </div>

  <!-- floating drag image & arrow -->
  <img id="drag-copy" alt="">
  <div id="tutorial-arrow">➡️</div>

  <!-- sounds (remote small files) -->
  <audio id="success-sound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
  <audio id="buzz-sound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
/*
  Fixed version:
  - inline SVG images (data URIs) that match the item names
  - pointer-based mobile drag (floating copy that follows finger)
  - continuous tutorial arrow for first 2 drag rounds
  - first-2-round hints per mode (adds pulse to correct box)
  - select/drag/missing/different modes
  - voice + sounds
*/

// -- helper to make data-URI from an SVG string (safe via encodeURIComponent)
function svgDataURI(svg){
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

// -- SVG image templates (simple recognizable icons)
const svgs = {
  apple: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
    <circle cx="50" cy="56" r="20" fill="#e74c3c"/>
    <path d="M58 35c6-6 14-6 22-3" fill="none" stroke="#5bbd42" stroke-width="4" stroke-linecap="round"/>
    <rect x="48" y="25" width="4" height="12" rx="1" fill="#6b3e1d"/>
  </svg>`,
  banana: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 80">
    <path d="M10,60 C30,5 90,5 110,60 C85,70 35,70 10,60" fill="#ffdd57" stroke="#e6c85b" stroke-width="2"/>
  </svg>`,
  dog: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
    <rect x="20" y="30" rx="8" ry="8" width="60" height="44" fill="#c4875a"/>
    <circle cx="35" cy="46" r="6" fill="#fff"/>
    <circle cx="65" cy="46" r="6" fill="#fff"/>
    <circle cx="35" cy="46" r="2.5" fill="#000"/>
    <circle cx="65" cy="46" r="2.5" fill="#000"/>
    <rect x="46" y="56" width="8" height="6" rx="3" fill="#5b3a2a"/>
  </svg>`,
  cat: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
    <circle cx="50" cy="50" r="28" fill="#9aa6af"/>
    <polygon points="28,32 40,18 46,34" fill="#9aa6af"/>
    <polygon points="72,32 60,18 54,34" fill="#9aa6af"/>
    <circle cx="42" cy="48" r="4" fill="#fff"/>
    <circle cx="58" cy="48" r="4" fill="#fff"/>
    <circle cx="42" cy="48" r="2" fill="#000"/>
    <circle cx="58" cy="48" r="2" fill="#000"/>
    <path d="M40 62 Q50 68 60 62" stroke="#6b6b6b" stroke-width="2" fill="none" stroke-linecap="round"/>
  </svg>`,
  flower: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
    <circle cx="50" cy="40" r="12" fill="#f1c40f"/>
    <circle cx="50" cy="20" r="12" fill="#ff6ea1"/>
    <circle cx="70" cy="35" r="12" fill="#ff6ea1"/>
    <circle cx="30" cy="35" r="12" fill="#ff6ea1"/>
    <circle cx="35" cy="55" r="12" fill="#ff6ea1"/>
    <circle cx="65" cy="55" r="12" fill="#ff6ea1"/>
    <rect x="48" y="55" width="4" height="25" fill="#2ecc71"/>
  </svg>`,
  star: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
    <polygon points="50,12 61,40 92,40 66,58 76,88 50,70 24,88 34,58 8,40 39,40" fill="#f1c40f"/>
  </svg>`,
  car: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 140 80">
    <rect x="10" y="30" width="120" height="30" rx="8" fill="#3498db"/>
    <rect x="34" y="12" width="72" height="30" rx="6" fill="#2c82d4"/>
    <circle cx="34" cy="62" r="10" fill="#333"/>
    <circle cx="106" cy="62" r="10" fill="#333"/>
  </svg>`,
  ball: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
    <circle cx="50" cy="50" r="30" fill="#e74c3c" />
    <path d="M20 50 a30 30 0 0 0 60 0" stroke="#fff" stroke-width="3" fill="none"/>
    <circle cx="50" cy="50" r="2" fill="#fff"/>
  </svg>`,
  tree: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
    <rect x="46" y="60" width="8" height="20" fill="#8b5a2b"/>
    <circle cx="50" cy="42" r="20" fill="#2ecc71"/>
    <circle cx="36" cy="50" r="12" fill="#2ecc71"/>
    <circle cx="64" cy="50" r="12" fill="#2ecc71"/>
  </svg>`,
  smile: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
    <circle cx="50" cy="50" r="30" fill="#ffd93b"/>
    <circle cx="40" cy="45" r="4" fill="#3d3d3d"/>
    <circle cx="60" cy="45" r="4" fill="#3d3d3d"/>
    <path d="M38 60 Q50 72 62 60" stroke="#3d3d3d" stroke-width="4" fill="none" stroke-linecap="round"/>
  </svg>`
};

// Build items array with id, name, src, (optional sound)
const ITEMS = [
  { id:'apple',  name:'apple',  svg: svgs.apple,  sound:'' },
  { id:'banana', name:'banana', svg: svgs.banana, sound:'' },
  { id:'dog',    name:'dog',    svg: svgs.dog,    sound:'https://actions.google.com/sounds/v1/animals/dog_bark.ogg' },
  { id:'cat',    name:'cat',    svg: svgs.cat,    sound:'https://actions.google.com/sounds/v1/animals/cat_meow.ogg' },
  { id:'flower', name:'flower', svg: svgs.flower, sound:'' },
  { id:'star',   name:'star',   svg: svgs.star,   sound:'' },
  { id:'car',    name:'car',    svg: svgs.car,    sound:'' },
  { id:'ball',   name:'ball',   svg: svgs.ball,   sound:'' },
  { id:'tree',   name:'tree',   svg: svgs.tree,   sound:'' },
  { id:'smile',  name:'smile',  svg: svgs.smile,  sound:'' }
].map(it => {
  // use URI-encoded SVG (no btoa needed)
  return { id: it.id, name: it.name, src: svgDataURI(it.svg), sound: it.sound || '' };
});

// Game state & counters
let score = 0;
let correctId = null;
let modeCounters = { select:0, drag:0, missing:0, different:0 };
let dragTutorialShown = 0;
let currentMode = null;

// DOM refs
const questionEl = document.getElementById('question');
const gridEl = document.getElementById('grid');
const puzzleEl = document.getElementById('puzzle');
const dropZoneEl = document.getElementById('drop-zone');
const msgEl = document.getElementById('message');
const scoreEl = document.getElementById('score');
const dragCopy = document.getElementById('drag-copy');
const tutorialArrow = document.getElementById('tutorial-arrow');
const successSound = document.getElementById('success-sound');
const buzzSound = document.getElementById('buzz-sound');

// Prevent pull-to-refresh/scroll while dragging on touch
document.addEventListener('touchmove', function(e){
  if(currentMode === 'drag') e.preventDefault();
}, {passive:false});

// util: shuffle
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

// speak helper (voice feedback)
function speak(text){
  if(!('speechSynthesis' in window)) return;
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'en-US'; u.rate = 0.95; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
  }catch(e){}
}

// Choose next mode with progression: give learning sequence then random
function decideMode(){
  // show each mode's first two rounds with hints/tutorials
  if(modeCounters.select < 2) return 'select';
  if(modeCounters.drag < 2) return 'drag';
  if(modeCounters.missing < 2) return 'missing';
  if(modeCounters.different < 2) return 'different';
  // After initial warmups: random mix
  const modes = ['select','select','drag','missing','different'];
  return modes[Math.floor(Math.random()*modes.length)];
}

// start a new round
function newRound(){
  msgEl.textContent = '';
  gridEl.innerHTML = '';
  puzzleEl.innerHTML = '';
  dropZoneEl.style.display = 'none';
  tutorialArrow.style.display = 'none';
  dragCopy.style.display = 'none';

  currentMode = decideMode();
  if(currentMode === 'select'){ modeCounters.select++; generateSelect(); }
  else if(currentMode === 'drag'){ modeCounters.drag++; generateDrag(); }
  else if(currentMode === 'missing'){ modeCounters.missing++; generateMissing(); }
  else { modeCounters.different++; generateDifferent(); }
}

// ---- SELECT MODE ----
function generateSelect(){
  const correct = ITEMS[Math.floor(Math.random()*ITEMS.length)];
  correctId = correct.id;
  questionEl.textContent = `Find the ${correct.name}!`;
  speak(questionEl.textContent);

  // options: 6 different items
  let options = [correct];
  while(options.length < 6){
    const it = ITEMS[Math.floor(Math.random()*ITEMS.length)];
    if(!options.some(o => o.id === it.id)) options.push(it);
  }
  shuffle(options);

  options.forEach(opt=>{
    const box = document.createElement('div'); box.className = 'answer-box';
    const img = document.createElement('img'); img.src = opt.src; img.alt = opt.name;
    img.dataset.id = opt.id;
    box.appendChild(img);
    box.addEventListener('click', ()=> handleSelect(opt.id, opt.sound, box) );
    gridEl.appendChild(box);
  });

  // show hint for first two select rounds
  if(modeCounters.select <= 2) showHintFor(correct.id);
}

// ---- DRAG MODE ----
function generateDrag(){
  const correct = ITEMS[Math.floor(Math.random()*ITEMS.length)];
  correctId = correct.id;
  questionEl.textContent = `Drag the ${correct.name} to the box!`;
  speak(questionEl.textContent);
  dropZoneEl.style.display = 'flex';

  // options: 6 different items
  let options = [correct];
  while(options.length < 6){
    const it = ITEMS[Math.floor(Math.random()*ITEMS.length)];
    if(!options.some(o => o.id === it.id)) options.push(it);
  }
  shuffle(options);

  options.forEach(opt=>{
    const box = document.createElement('div'); box.className = 'answer-box';
    const img = document.createElement('img'); img.src = opt.src; img.alt = opt.name;
    img.dataset.id = opt.id;
    box.appendChild(img);
    gridEl.appendChild(box);

    // enable pointer-based drag for mobile and desktop
    enablePointerDrag(img, opt.id, opt.sound);
  });

  // continuous tutorial arrow for first 2 drag rounds
  if(modeCounters.drag <= 2){
    dragTutorialShown++;
    showDragArrowLoop();
  }
}

// pointer drag implementation (floating copy)
function enablePointerDrag(imgEl, itemId, itemSound){
  let moveHandler, upHandler;
  function onPointerDown(e){
    e.preventDefault();
    // show copy and move with pointer
    dragCopy.src = imgEl.src;
    dragCopy.style.display = 'block';
    const offset = 44; // center offset
    dragCopy.style.left = (e.pageX - offset) + 'px';
    dragCopy.style.top  = (e.pageY - offset) + 'px';

    moveHandler = function(ev){
      dragCopy.style.left = (ev.pageX - offset) + 'px';
      dragCopy.style.top  = (ev.pageY - offset) + 'px';
    };

    upHandler = function(ev){
      // hide copy & remove listeners
      dragCopy.style.display = 'none';
      document.removeEventListener('pointermove', moveHandler);
      document.removeEventListener('pointerup', upHandler);
      // detect drop over drop zone
      const dz = dropZoneEl.getBoundingClientRect();
      if(ev.clientX > dz.left && ev.clientX < dz.right && ev.clientY > dz.top && ev.clientY < dz.bottom){
        // dropped in zone
        handleDrop(itemId, itemSound);
      }
    };

    document.addEventListener('pointermove', moveHandler);
    document.addEventListener('pointerup', upHandler);
  }

  imgEl.addEventListener('pointerdown', onPointerDown);
}

// ---- MISSING PIECE MODE ----
function generateMissing(){
  // pick 6 distinct items, hide one in puzzle display and give 3 options (one correct)
  const pool = shuffle(ITEMS.slice());
  const sequence = pool.slice(0,6);
  const missingIndex = Math.floor(Math.random()*sequence.length);
  correctId = sequence[missingIndex].id;

  questionEl.textContent = 'Find the missing piece!';
  speak(questionEl.textContent);

  // show sequence in puzzle area but omit the missing one (show placeholders)
  puzzleEl.innerHTML = '';
  sequence.forEach((it, idx) => {
    const div = document.createElement('div'); div.className = 'answer-box';
    if(idx !== missingIndex){
      const img = document.createElement('img'); img.src = it.src; img.alt = it.name; div.appendChild(img);
    } else {
      // placeholder empty box
      div.style.boxShadow = 'inset 0 0 0 3px rgba(0,0,0,0.06)';
      div.innerHTML = ''; // intentionally blank
    }
    puzzleEl.appendChild(div);
  });

  // options: include correct + 2 distractors
  let options = [sequence[missingIndex]];
  while(options.length < 3){
    const it = ITEMS[Math.floor(Math.random()*ITEMS.length)];
    if(!options.some(o => o.id === it.id)) options.push(it);
  }
  shuffle(options);

  gridEl.innerHTML = '';
  options.forEach(opt=>{
    const box = document.createElement('div'); box.className='answer-box';
    const img = document.createElement('img'); img.src = opt.src; img.alt = opt.name; img.dataset.id = opt.id;
    box.appendChild(img);
    box.addEventListener('click', ()=> handleSelect(opt.id, opt.sound, box));
    gridEl.appendChild(box);
  });

  if(modeCounters.missing <= 2) showHintFor(correctId);
}

// ---- FIND DIFFERENT MODE ----
function generateDifferent(){
  // pick a base item and one different item, show 6 boxes (5 base + 1 different)
  const base = ITEMS[Math.floor(Math.random()*ITEMS.length)];
  let different;
  do { different = ITEMS[Math.floor(Math.random()*ITEMS.length)]; } while(different.id === base.id);
  correctId = different.id;

  questionEl.textContent = 'Find the different item!';
  speak(questionEl.textContent);

  let arr = [different];
  for(let i=0;i<5;i++) arr.push(base);
  shuffle(arr);

  arr.forEach(opt=>{
    const box = document.createElement('div'); box.className='answer-box';
    const img = document.createElement('img'); img.src = opt.src; img.alt = opt.name; img.dataset.id = opt.id;
    box.appendChild(img);
    box.addEventListener('click', ()=> handleSelect(opt.id, opt.sound, box));
    gridEl.appendChild(box);
  });

  if(modeCounters.different <= 2) showHintFor(correctId);
}

// ---- ANSWER HANDLERS ----
function handleSelect(selectedId, itemSound, boxEl){
  // button/select click path
  const boxes = Array.from(document.querySelectorAll('.answer-box'));
  boxes.forEach(b => b.classList.remove('correct','wrong','hintPulse'));
  if(selectedId === correctId){
    successFeedback(selectedId, itemSound);
    // mark correct box
    boxes.forEach(b => {
      const img = b.querySelector('img');
      if(img && img.dataset.id === selectedId) b.classList.add('correct');
    });
    setTimeout(newRound, 900);
  } else {
    // mark wrong one
    if(boxEl) boxEl.classList.add('wrong');
    buzzFeedback();
  }
}

function handleDrop(selectedId, itemSound){
  // drag drop path
  const boxes = Array.from(document.querySelectorAll('.answer-box'));
  boxes.forEach(b => b.classList.remove('correct','wrong','hintPulse'));
  if(selectedId === correctId){
    successFeedback(selectedId, itemSound);
    boxes.forEach(b => {
      const img = b.querySelector('img');
      if(img && img.dataset.id === selectedId) b.classList.add('correct');
    });
    // stop tutorial arrow if visible
    tutorialArrow.style.display = 'none';
    setTimeout(newRound, 900);
  } else {
    buzzFeedback();
  }
}

function successFeedback(selectedId, itemSound){
  successSound.currentTime = 0; successSound.play();
  if(itemSound) try{ new Audio(itemSound).play(); }catch(e){}
  msgEl.textContent = '✅ Correct!';
  score++; scoreEl.textContent = 'Score: ' + score;
  speak('Correct!');
}

function buzzFeedback(){
  buzzSound.currentTime = 0; buzzSound.play();
  msgEl.textContent = '❌ Try again!';
  speak('Try again!');
}

// ---- HINTS & Tutorial ----
function showHintFor(itemId){
  // highlight the box with that image (if present) briefly
  setTimeout(()=>{ // small delay so elements exist
    const imgs = Array.from(document.querySelectorAll('.answer-box img'));
    const match = imgs.find(i => i.dataset.id === itemId);
    if(match){
      const box = match.parentElement;
      box.classList.add('hintPulse');
      setTimeout(()=> box.classList.remove('hintPulse'), 1600);
    }
  }, 120);
}

let arrowInterval = null;
function showDragArrowLoop(){
  tutorialArrow.style.display = 'block';
  // find first draggable image and the drop zone
  const firstImg = document.querySelector('.answer-box img');
  if(!firstImg) return; // nothing to animate yet
  const imgRect = firstImg.getBoundingClientRect();
  const dzRect = dropZoneEl.getBoundingClientRect();
  // arrow path from image to drop zone center - loop back and forth
  let t=0;
  if(arrowInterval) clearInterval(arrowInterval);
  arrowInterval = setInterval(()=>{
    // recompute source because layout may reflow on mobile
    const sRect = firstImg.getBoundingClientRect();
    const dRect = dropZoneEl.getBoundingClientRect();
    const sx = sRect.left + sRect.width/2;
    const sy = sRect.top + sRect.height/2;
    const dx = dRect.left + dRect.width/2;
    const dy = dRect.top + dRect.height/2;
    // progress oscillates 0->1->0
    const p = (t % 60) / 30;
    const progress = p <= 1 ? p : 2 - p;
    const x = Math.round(sx + (dx - sx) * progress - 24);
    const y = Math.round(sy + (dy - sy) * progress - 24);
    tutorialArrow.style.left = x + 'px';
    tutorialArrow.style.top = y + 'px';
    t++;
  }, 28);
  // stop after 8 seconds if user doesn't interact
  setTimeout(()=>{ if(arrowInterval){ clearInterval(arrowInterval); arrowInterval = null; tutorialArrow.style.display='none'; } }, 8000);
}

// Start game
newRound();

</script>
</body>
</html>
