<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colors Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .bouncy-tap { transition: transform 0.1s ease-in-out; }
        .bouncy-tap:active { transform: scale(0.95); }
        .incorrect-animation { animation: incorrect-shake 0.3s ease-in-out; }
        .correct-pop-out {
            position: relative;
            z-index: 50;
            animation: popOut 0.8s ease-in-out forwards;
        }
        .correct-pop-out::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 150%;
            height: 150%;
            border-radius: 50%;
            background-image: radial-gradient(circle, white 10%, transparent 10%), radial-gradient(circle, white 10%, transparent 10%);
            background-position: 0% 0%, 100% 100%;
            background-size: 50% 50%, 50% 50%;
            background-repeat: no-repeat;
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            animation: diamond-shine 0.8s ease-out forwards;
            pointer-events: none;
        }
        @keyframes incorrect-shake { 0%,100%{transform:translateX(0);}25%{transform:translateX(-5px);}75%{transform:translateX(5px);} }
        @keyframes popOut { 0% {transform:scale(1);} 50% {transform:scale(1.5);} 100% {transform:scale(1);} }
        @keyframes diamond-shine { 0% {transform:translate(-50%,-50%) scale(0);opacity:0;} 50% {transform:translate(-50%,-50%) scale(1);opacity:1;} 100% {transform:translate(-50%,-50%) scale(1.5);opacity:0;} }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4 overflow-hidden">
  <div id="game-container" class="w-full max-w-lg p-6 bg-white rounded-3xl shadow-xl flex flex-col items-center space-y-8">
    <h1 id="game-title" class="text-4xl sm:text-5xl font-bold text-center text-gray-800">
      Find the <span id="color-name" class="text-blue-500">...</span>
    </h1>
    <div id="score-board" class="w-full text-center text-2xl font-bold text-gray-600">
      Score: <span id="score-count">0</span>
    </div>
    <div id="colors-grid" class="flex flex-wrap justify-center items-center gap-6 w-full"></div>
    <button id="leave-game-btn" class="mt-4 px-6 py-3 rounded-full shadow-lg font-bold text-lg transform active:scale-95 transition-transform">
        Leave Game
    </button>
  </div>
  <div id="win-screen" class="absolute inset-0 bg-blue-500 bg-opacity-90 flex flex-col items-center justify-center p-4 space-y-8 z-20 hidden">
    <h2 id="win-message" class="text-6xl font-extrabold text-white text-center">You Did It!</h2>
    <p id="win-subtext" class="text-2xl text-white text-center font-semibold">You completed a level!</p>
    <button id="back-to-menu-btn" class="px-8 py-4 rounded-full shadow-lg font-bold text-lg transform active:scale-95 transition-transform">
        Back to Menu
    </button>
  </div>
  
  <!-- Audio element for the bell sound -->
  <audio id="bell-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" preload="auto"></audio>
  
<script>
  // ðŸŽ¨ Colors
  const allColors = [
    { name: 'Red', hex: '#ef4444' }, { name: 'Blue', hex: '#3b82f6' },
    { name: 'Green', hex: '#22c55e' }, { name: 'Yellow', hex: '#facc15' },
    { name: 'Purple', hex: '#a855f7' }, { name: 'Orange', hex: '#f97316' },
    { name: 'Pink', hex: '#ec4899' }, { name: 'Brown', hex: '#8a4b08' },
    { name: 'Gray', hex: '#9ca3af' }, { name: 'Black', hex: '#111827' },
    { name: 'White', hex: '#f9fafb' }, { name: 'Teal', hex: '#14b8a6' },
  ];
  
  // Game state
  let correctColor = null, previousColor = null, score = 0, totalCorrectAnswers = 0;
  let isProcessing = false; // Flag to prevent multiple simultaneous actions
  const COLORS_PER_LEVEL = [4, 6, 8, 10, 12];
  const CORRECT_ANSWERS_TO_LEVEL_UP = 6;

  // Speech synthesis management
  let speechQueue = [];
  let isSpeaking = false;

  const processSpeechQueue = () => {
    if (speechQueue.length === 0 || isSpeaking) return;
    
    isSpeaking = true;
    const { text, rate, resolve } = speechQueue.shift();
    
    if ('speechSynthesis' in window) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = rate;
      utterance.onend = () => {
        utterance.onend = null;
        isSpeaking = false;
        resolve();
        processSpeechQueue();
      };
      utterance.onerror = () => {
        utterance.onerror = null;
        isSpeaking = false;
        resolve();
        processSpeechQueue();
      };
      window.speechSynthesis.speak(utterance);
    } else {
      isSpeaking = false;
      resolve();
      processSpeechQueue();
    }
  };

  const speak = (text, rate = 0.9) => {
    return new Promise(resolve => {
      speechQueue.push({ text, rate, resolve });
      processSpeechQueue();
    });
  };

  const cancelAllSpeech = () => {
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
    }
    speechQueue = [];
    isSpeaking = false;
  };

  const createColorButton = (color) => {
    const button = document.createElement('div');
    button.className = "w-20 h-20 md:w-24 md:h-24 rounded-3xl shadow-md cursor-pointer transition-all bouncy-tap";
    button.style.backgroundColor = color.hex;
    button.dataset.colorName = color.name;
    return button;
  };

  const updateScoreDisplay = () => { document.getElementById('score-count').textContent = totalCorrectAnswers; };

  const showCelebrationScreen = async (message, subtext) => {
      const gameContainer = document.getElementById('game-container');
      const winScreen = document.getElementById('win-screen');
      gameContainer.classList.add('hidden');
      winScreen.classList.remove('hidden');
      document.getElementById('win-message').textContent = message;
      document.getElementById('win-subtext').textContent = subtext;

      // Update button colors to match the correct color
      document.getElementById('back-to-menu-btn').style.backgroundColor = correctColor.hex;
      document.getElementById('back-to-menu-btn').style.color = correctColor.name === 'Black' || correctColor.name === 'Brown' ? 'white' : 'black';

      // Speak the message and wait for it to finish
      await speak(message, 0.8);

      setTimeout(() => {
          winScreen.classList.add('hidden');
          gameContainer.classList.remove('hidden');
          setupNewRound();
      }, 500);
  };

  const handleTap = async (e) => {
      if (isProcessing) return; // Prevent multiple taps during processing
      isProcessing = true;
      
      const tapped = e.target.dataset.colorName;
      const btn = e.target;
      
      if (tapped === correctColor.name) {
          totalCorrectAnswers++;
          score++;
          
          // Play bell sound for correct answer
          const bellSound = document.getElementById('bell-sound');
          if (bellSound) {
            bellSound.currentTime = 0;
            bellSound.play().catch(e => console.log("Audio play failed:", e));
          }
          
          btn.classList.add('correct-pop-out');
          
          // Remove any existing event listeners to prevent duplicates
          const newHandler = async function handler() {
              btn.removeEventListener('animationend', handler);
              
              await speak(correctColor.name, 0.7);

              btn.classList.remove('correct-pop-out');
              
              if (score >= CORRECT_ANSWERS_TO_LEVEL_UP) {
                  score = 0;
                  showCelebrationScreen('Great Job!', 'You unlocked the next level!');
              } else {
                  setupNewRound();
              }
              updateScoreDisplay();
              isProcessing = false;
          };
          
          btn.addEventListener('animationend', newHandler, { once: true });
          
      } else {
          score = 0;
          
          // Cancel any ongoing speech
          cancelAllSpeech();
          isProcessing = false;
      }
  };

  const resetGame = () => {
      // Remove all event listeners from color buttons
      const grid = document.getElementById('colors-grid');
      while (grid.firstChild) {
          grid.removeChild(grid.firstChild);
      }
      correctColor = null;
      cancelAllSpeech(); // Clear any queued speech
  };

  const setupNewRound = () => {
      resetGame();
      isProcessing = false; // Reset processing flag
      
      const display = document.getElementById('color-name');
      const levelIndex = Math.min(Math.floor(totalCorrectAnswers / CORRECT_ANSWERS_TO_LEVEL_UP), COLORS_PER_LEVEL.length - 1);
      const num = COLORS_PER_LEVEL[levelIndex];
      const shuffled = [...allColors].sort(() => Math.random() - 0.5);
      let newColor;
      do { newColor = shuffled[0]; } while (newColor.name === previousColor?.name);
      correctColor = newColor;
      previousColor = correctColor;
      const round = shuffled.slice(0, num);
      if (!round.some(c => c.name === correctColor.name)) round[0] = correctColor;
      round.sort(() => Math.random() - 0.5);
      display.textContent = correctColor.name;
      display.style.color = correctColor.hex;
      
      // Update leave game button color
      document.getElementById('leave-game-btn').style.backgroundColor = correctColor.hex;
      document.getElementById('leave-game-btn').style.color = correctColor.name === 'Black' || correctColor.name === 'Brown' ? 'white' : 'black';
      
      // Cancel any ongoing speech and speak the new instruction
      cancelAllSpeech();
      speak(`Find the color ${correctColor.name}`);
      
      const grid = document.getElementById('colors-grid');
      round.forEach(c => { 
          const b = createColorButton(c); 
          b.addEventListener('click', handleTap); 
          grid.appendChild(b); 
      });
  };

  // Initialize the game
  window.onload = () => { 
      setupNewRound(); 
      updateScoreDisplay(); 
      
      // Add event listener for leave game button
      document.getElementById('leave-game-btn').addEventListener('click', () => {
          window.location.href = 'index.html';
      });
      
      // Add event listener for back to menu button
      document.getElementById('back-to-menu-btn').addEventListener('click', () => {
          window.location.href = 'index.html';
      });
  };

  // Clean up when the page is hidden to prevent speech issues
  document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
          cancelAllSpeech();
      }
  });
</script>
</body>
</html>
