<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colors Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .bouncy-tap {
            transition: transform 0.1s ease-in-out;
        }
        .bouncy-tap:active {
            transform: scale(0.95);
        }
        .incorrect-animation {
            animation: incorrect-shake 0.3s ease-in-out;
        }
        .correct-pop-out {
            position: relative;
            z-index: 50; /* Bring to front */
            animation: popOut 0.8s ease-in-out forwards;
        }
        .correct-pop-out::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 150%;
            height: 150%;
            border-radius: 50%;
            background-image: radial-gradient(circle, white 10%, transparent 10%),
                              radial-gradient(circle, white 10%, transparent 10%);
            background-position: 0% 0%, 100% 100%;
            background-size: 50% 50%, 50% 50%;
            background-repeat: no-repeat;
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            animation: diamond-shine 0.8s ease-out forwards;
            pointer-events: none;
        }
        @keyframes incorrect-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        @keyframes popOut {
            0% { transform: scale(1); box-shadow: 0 0 10px rgba(0,0,0,0.2); }
            50% { transform: scale(1.5); box-shadow: 0 0 25px 10px rgba(255, 255, 255, 0.8), 0 0 50px 20px rgba(255, 255, 255, 0.6); }
            100% {
                transform: scale(1.5);
                box-shadow:
                    0 0 10px rgba(0,0,0,0.2),
                    0 0 50px 20px rgba(255, 255, 255, 0.8),
                    0 0 100px 30px rgba(255, 255, 255, 0.6),
                    0 0 150px 40px rgba(255, 255, 255, 0.4),
                    0 0 200px 50px rgba(255, 255, 255, 0.2);
            }
        }
        @keyframes diamond-shine {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }
        .fireworks-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 10;
        }
        .firework {
            position: absolute;
            width: 5px;
            height: 5px;
            background-color: #fff;
            border-radius: 50%;
            animation: explode 1s ease-out forwards;
        }
        @keyframes explode {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(100);
                opacity: 0;
            }
        }
        .star {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #facc15; /* Yellow star color */
            border-radius: 50%;
            transform: scale(0);
            opacity: 0;
            animation: sparkle 0.8s ease-out forwards;
        }
        @keyframes sparkle {
            0% { transform: scale(0); opacity: 0; }
            30% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0); opacity: 0; transform: translateY(-50px); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4 overflow-hidden">
    <div id="game-container" class="w-full max-w-lg p-6 bg-white rounded-3xl shadow-xl flex flex-col items-center space-y-8">
        <!-- Title and Prompt -->
        <h1 id="game-title" class="text-4xl sm:text-5xl font-bold text-center text-gray-800">
            Find the <span id="color-name" class="text-blue-500">...</span>
        </h1>
        
        <!-- Scoreboard -->
        <div id="score-board" class="w-full text-center text-2xl font-bold text-gray-600">
            Score: <span id="score-count">0</span>
        </div>

        <!-- The game area for colors -->
        <div id="colors-grid" class="flex flex-wrap justify-center items-center gap-6 w-full">
            <!-- Color buttons will be dynamically generated here by JavaScript -->
        </div>

        <!-- Correct/Incorrect message box -->
        <div id="message-box" class="min-h-16 w-full text-center">
            <p id="message-text" class="text-xl font-semibold hidden"></p>
        </div>
    </div>

    <!-- Celebration Screen -->
    <div id="win-screen" class="absolute inset-0 bg-blue-500 bg-opacity-90 flex flex-col items-center justify-center p-4 space-y-8 z-20 hidden">
        <div class="fireworks-container" id="fireworks"></div>
        <h2 id="win-message" class="text-6xl font-extrabold text-white text-center">You Did It!</h2>
        <p id="win-subtext" class="text-2xl text-white text-center font-semibold">You found all the colors!</p>
        <button id="back-to-menu-btn" class="bg-white text-blue-600 px-8 py-4 rounded-full shadow-lg font-bold text-lg transform active:scale-95 transition-transform">
            Back to Menu
        </button>
    </div>

    <script>
        // Data for the colors. This is the core of our "database".
        const allColors = [
            { name: 'Red', hex: '#ef4444' },
            { name: 'Blue', hex: '#3b82f6' },
            { name: 'Green', hex: '#22c55e' },
            { name: 'Yellow', hex: '#facc15' },
            { name: 'Purple', hex: '#a855f7' },
            { name: 'Orange', hex: '#f97316' },
            { name: 'Pink', hex: '#ec4899' },
            { name: 'Brown', hex: '#8a4b08' },
            { name: 'Gray', hex: '#9ca3af' },
            { name: 'Black', hex: '#111827' },
            { name: 'White', hex: '#f9fafb' },
            { name: 'Teal', hex: '#14b8a6' },
        ];

        const positiveFeedback = ['Excellent!', 'Great Job!', 'You are doing great!', 'Fantastic!', 'Super!'];
        const negativeFeedback = ['Oops, try again!', 'Not quite, give it another go!', 'You can do it!'];
        
        // Game state variables
        let correctColor = null;
        let previousColor = null;
        let score = 0;
        let currentLevel = 1;
        let fireworkIntervalId = null;
        
        // Game progression settings
        const CORRECT_ANSWERS_TO_LEVEL_UP = 5;
        const CELEBRATION_LEVEL_INTERVAL = 2; // For testing, a smaller interval works well
        const COLORS_PER_LEVEL = [4, 6, 8, 8, 10, 10, 12, 12, 12, 12]; // Colors for levels 1-10

        const speak = (text, callback, rate = 0.9) => {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.voice = speechSynthesis.getVoices().find(voice => voice.name === 'Google UK English Female') || speechSynthesis.getVoices()[0];
                utterance.rate = rate;
                utterance.onend = () => {
                    if (callback) callback();
                };
                window.speechSynthesis.speak(utterance);
            } else if (callback) {
                callback();
            }
        };

        const createColorButton = (color) => {
            const button = document.createElement('div');
            const baseClasses = `w-20 h-20 md:w-24 md:h-24 rounded-3xl shadow-md cursor-pointer transition-all bouncy-tap`;
            button.className = baseClasses;
            button.style.backgroundColor = color.hex;
            button.dataset.colorName = color.name;
            button.dataset.colorHex = color.hex;
            return button;
        };

        const updateScoreDisplay = () => {
            document.getElementById('score-count').textContent = score;
        };
        
        const generateFirework = () => {
            const firework = document.createElement('div');
            firework.className = 'firework';
            const size = Math.random() * 20 + 5;
            firework.style.width = `${size}px`;
            firework.style.height = `${size}px`;
            firework.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 80%)`;
            firework.style.left = `${Math.random() * 100}vw`;
            firework.style.top = `${Math.random() * 100}vh`;
            document.getElementById('fireworks').appendChild(firework);
            firework.addEventListener('animationend', () => firework.remove());
        };

        const generateStars = (button) => {
            const buttonRect = button.getBoundingClientRect();
            const starCount = 10;
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = `${buttonRect.left + buttonRect.width / 2 + (Math.random() - 0.5) * 50}px`;
                star.style.top = `${buttonRect.top + buttonRect.height / 2 + (Math.random() - 0.5) * 50}px`;
                document.body.appendChild(star);
                star.addEventListener('animationend', () => star.remove());
            }
        };

        const showCelebrationScreen = (message, subtext, isFinalWin = false) => {
            const gameContainer = document.getElementById('game-container');
            const winScreen = document.getElementById('win-screen');
            gameContainer.classList.add('hidden');
            winScreen.classList.remove('hidden');

            document.getElementById('win-message').textContent = message;
            document.getElementById('win-subtext').textContent = subtext;

            const backButton = document.getElementById('back-to-menu-btn');
            if (isFinalWin) {
                backButton.classList.remove('hidden');
                backButton.onclick = () => {
                    window.location.href = 'main_page.html';
                };
            } else {
                backButton.classList.add('hidden');
            }

            // Start fireworks and store the ID to clear it later
            fireworkIntervalId = setInterval(generateFirework, 200);
            
            speak(message, () => {
                if (!isFinalWin) {
                    setTimeout(() => {
                        winScreen.classList.add('hidden');
                        gameContainer.classList.remove('hidden');
                        clearInterval(fireworkIntervalId); // Stop fireworks
                        setupNewRound();
                    }, 3000); // 3-second delay before next round
                }
            });
        };

        const handleTap = (event) => {
            const tappedColorName = event.target.dataset.colorName;
            const messageText = document.getElementById('message-text');
            const tappedButton = event.target;

            if (tappedColorName === correctColor.name) {
                score++;
                
                tappedButton.classList.add('correct-pop-out');
                generateStars(tappedButton);
                
                const chime = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3');
                try {
                    chime.play().catch(e => console.error("Audio playback interrupted:", e));
                } catch (e) {
                    console.error("Audio playback error:", e);
                }

                const randomFeedback = positiveFeedback[Math.floor(Math.random() * positiveFeedback.length)];

                // Chained speech to ensure smooth playback and prevent hangs
                speak(correctColor.name, () => {
                    speak(randomFeedback, () => {
                        messageText.textContent = randomFeedback;
                        messageText.classList.remove('hidden');
                        messageText.style.color = correctColor.hex;
                        
                        setTimeout(() => {
                            tappedButton.classList.remove('correct-pop-out');
                            messageText.classList.add('hidden');
                            updateScoreDisplay();

                            if (score >= CORRECT_ANSWERS_TO_LEVEL_UP) {
                                currentLevel++;
                                score = 0;
                                updateScoreDisplay();

                                if (currentLevel % CELEBRATION_LEVEL_INTERVAL === 0) {
                                    showCelebrationScreen('Great Job!', `You completed Level ${currentLevel - 1}!`, false);
                                } else {
                                    setupNewRound();
                                }
                            } else {
                                setupNewRound();
                            }
                        }, 800); // Matches the popOut animation duration
                    }, 0.9);
                }, 0.7);
            } else {
                score = 0;
                updateScoreDisplay();
                tappedButton.classList.add('incorrect-animation');
                const randomFeedback = negativeFeedback[Math.floor(Math.random() * negativeFeedback.length)];
                messageText.textContent = randomFeedback;
                messageText.classList.remove('hidden');
                messageText.style.color = correctColor.hex; 
                speak(randomFeedback);

                tappedButton.addEventListener('animationend', () => {
                    tappedButton.classList.remove('incorrect-animation');
                }, { once: true });
            }
        };

        const resetGame = () => {
             const colorsGrid = document.getElementById('colors-grid');
             colorsGrid.innerHTML = '';
             correctColor = null;
        }

        const setupNewRound = () => {
            resetGame();

            const colorNameDisplay = document.getElementById('color-name');
            const numColorsToShow = COLORS_PER_LEVEL[currentLevel - 1] || allColors.length;
            
            const shuffledColors = allColors.sort(() => Math.random() - 0.5);
            
            let newCorrectColor;
            do {
                newCorrectColor = shuffledColors[0];
            } while (newCorrectColor.name === previousColor?.name);

            correctColor = newCorrectColor;
            previousColor = correctColor;
            
            const roundColors = shuffledColors.slice(0, numColorsToShow);
            if (!roundColors.includes(correctColor)) {
                roundColors[0] = correctColor; // Ensure the correct color is always in the list
            }
            roundColors.sort(() => Math.random() - 0.5);

            colorNameDisplay.textContent = correctColor.name;
            colorNameDisplay.style.color = correctColor.hex;

            speak(`Find the color ${correctColor.name}.`);

            const colorsGrid = document.getElementById('colors-grid');
            
            roundColors.forEach(color => {
                const button = createColorButton(color);
                button.addEventListener('click', handleTap);
                colorsGrid.appendChild(button);
            });
        };

        window.onload = () => {
            setTimeout(() => {
                setupNewRound();
                updateScoreDisplay();
            }, 500); 
        };
    </script>
</body>
</html>
